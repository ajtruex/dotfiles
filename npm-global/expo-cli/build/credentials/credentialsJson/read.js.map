{"version":3,"sources":["../../../src/credentials/credentialsJson/read.ts"],"names":["CredentialsJsonSchema","Joi","object","android","keystore","keystorePath","string","required","keystorePassword","keyAlias","keyPassword","ios","provisioningProfilePath","distributionCertificate","path","password","experimental","npmToken","fileExistsAsync","projectDir","fs","pathExists","join","readAndroidCredentialsAsync","credentialsJson","readAsync","Error","keystoreInfo","readFile","getAbsolutePath","readIosCredentialsAsync","provisioningProfile","certP12","certPassword","readSecretEnvsAsync","undefined","NPM_TOKEN","credentialsJSONRaw","readRawAsync","value","error","validate","stripUnknown","convert","abortEarly","toString","credentialsJsonFilePath","credentialsJSONContents","JSON","parse","err","filePath","isAbsolute"],"mappings":"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","sourcesContent":["import Joi from '@hapi/joi';\nimport fs from 'fs-extra';\nimport path from 'path';\n\nimport { Keystore } from '../credentials';\n\ninterface CredentialsJson {\n  android?: {\n    keystore: {\n      keystorePath: string;\n      keystorePassword: string;\n      keyAlias: string;\n      keyPassword: string;\n    };\n  };\n  ios?: {\n    provisioningProfilePath: string;\n    distributionCertificate: {\n      path: string;\n      password: string;\n    };\n  };\n  experimental?: {\n    npmToken?: string;\n  };\n}\n\nconst CredentialsJsonSchema = Joi.object({\n  android: Joi.object({\n    keystore: Joi.object({\n      keystorePath: Joi.string().required(),\n      keystorePassword: Joi.string().required(),\n      keyAlias: Joi.string().required(),\n      keyPassword: Joi.string().required(),\n    }),\n  }),\n  ios: Joi.object({\n    provisioningProfilePath: Joi.string().required(),\n    distributionCertificate: Joi.object({\n      path: Joi.string().required(),\n      password: Joi.string().required(),\n    }).required(),\n  }),\n  experimental: Joi.object({\n    npmToken: Joi.string(),\n  }),\n});\n\ninterface AndroidCredentials {\n  keystore: Keystore;\n}\n\ninterface iOSCredentials {\n  provisioningProfile: string;\n  distributionCertificate: {\n    certP12: string;\n    certPassword: string;\n  };\n}\n\nexport async function fileExistsAsync(projectDir: string): Promise<boolean> {\n  return await fs.pathExists(path.join(projectDir, 'credentials.json'));\n}\n\nexport async function readAndroidCredentialsAsync(projectDir: string): Promise<AndroidCredentials> {\n  const credentialsJson = await readAsync(projectDir);\n  if (!credentialsJson.android) {\n    throw new Error('Android credentials are missing from credentials.json'); // TODO: add fyi\n  }\n  const keystoreInfo = credentialsJson.android.keystore;\n  return {\n    keystore: {\n      keystore: await fs.readFile(getAbsolutePath(projectDir, keystoreInfo.keystorePath), 'base64'),\n      keystorePassword: keystoreInfo.keystorePassword,\n      keyAlias: keystoreInfo.keyAlias,\n      keyPassword: keystoreInfo.keyPassword,\n    },\n  };\n}\n\nexport async function readIosCredentialsAsync(projectDir: string): Promise<iOSCredentials> {\n  const credentialsJson = await readAsync(projectDir);\n  if (!credentialsJson.ios) {\n    throw new Error('iOS credentials are missing from credentials.json'); // TODO: add fyi\n  }\n  return {\n    provisioningProfile: await fs.readFile(\n      getAbsolutePath(projectDir, credentialsJson.ios.provisioningProfilePath),\n      'base64'\n    ),\n    distributionCertificate: {\n      certP12: await fs.readFile(\n        getAbsolutePath(projectDir, credentialsJson.ios.distributionCertificate.path),\n        'base64'\n      ),\n      certPassword: credentialsJson.ios.distributionCertificate.password,\n    },\n  };\n}\n\nexport async function readSecretEnvsAsync(\n  projectDir: string\n): Promise<Record<string, string> | undefined> {\n  if (!(await fileExistsAsync(projectDir))) {\n    return undefined;\n  }\n  const credentialsJson = await readAsync(projectDir);\n  const npmToken = credentialsJson?.experimental?.npmToken;\n  return npmToken ? { NPM_TOKEN: npmToken } : undefined;\n}\n\nasync function readAsync(projectDir: string): Promise<CredentialsJson> {\n  const credentialsJSONRaw = await readRawAsync(projectDir);\n\n  const { value: credentialsJson, error } = CredentialsJsonSchema.validate(credentialsJSONRaw, {\n    stripUnknown: true,\n    convert: true,\n    abortEarly: false,\n  });\n  if (error) {\n    throw new Error(`credentials.json is not valid [${error.toString()}]`);\n  }\n\n  return credentialsJson;\n}\n\nexport async function readRawAsync(projectDir: string): Promise<any> {\n  const credentialsJsonFilePath = path.join(projectDir, 'credentials.json');\n  try {\n    const credentialsJSONContents = await fs.readFile(credentialsJsonFilePath, 'utf8');\n    return JSON.parse(credentialsJSONContents);\n  } catch (err) {\n    throw new Error(\n      `credentials.json must exist in the project root directory and contain a valid JSON`\n    );\n  }\n}\n\nconst getAbsolutePath = (projectDir: string, filePath: string): string =>\n  path.isAbsolute(filePath) ? filePath : path.join(projectDir, filePath);\n"],"file":"read.js"}