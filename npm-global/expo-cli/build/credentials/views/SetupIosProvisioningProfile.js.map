{"version":3,"sources":["../../../src/credentials/views/SetupIosProvisioningProfile.ts"],"names":["SetupIosProvisioningProfile","constructor","app","open","ctx","user","Error","distCert","ios","getDistCert","appCredentials","getAppCredentials","configuredProfile","getProvisioningProfile","configuredWithSameDistCert","distCredentialsId","id","iosProfileView","CreateOrReuseProvisioningProfile","hasAppleCtx","isValid","validateProfileWithoutApple","bundleIdentifier","provisioningProfileId","chalk","yellow","profileFromApple","getAppleInfo","appleCtx","configureAndUpdateProvisioningProfile"],"mappings":";;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAIA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;;;;;AAOO,MAAMA,2BAAN,CAAmD;AACxDC,EAAAA,WAAW,CAASC,GAAT,EAA+B;AAAA,SAAtBA,GAAsB,GAAtBA,GAAsB;AAAE;;AAE5C,QAAMC,IAAN,CAAWC,GAAX,EAAgD;AAC9C,QAAI,CAACA,GAAG,CAACC,IAAT,EAAe;AACb,YAAM,IAAIC,KAAJ,CAAW,6CAAX,CAAN;AACD;;AAED,UAAMC,QAAQ,GAAG,MAAMH,GAAG,CAACI,GAAJ,CAAQC,WAAR,CAAoB,KAAKP,GAAzB,CAAvB;;AACA,QAAI,CAACK,QAAL,EAAe;AACb;AACA;AACA,YAAM,IAAID,KAAJ,CAAU,6DAAV,CAAN;AACD;;AAED,UAAMI,cAAc,GAAG,MAAMN,GAAG,CAACI,GAAJ,CAAQG,iBAAR,CAA0B,KAAKT,GAA/B,CAA7B,CAZ8C,CAc9C;;AACA,UAAMU,iBAAiB,GAAG,MAAMR,GAAG,CAACI,GAAJ,CAAQK,sBAAR,CAA+B,KAAKX,GAApC,CAAhC,CAf8C,CAiB9C;AACA;;AACA,UAAMY,0BAA0B,GAAGJ,cAAc,CAACK,iBAAf,KAAqCR,QAAQ,CAACS,EAAjF;;AACA,QAAI,CAACJ,iBAAD,IAAsB,CAACE,0BAA3B,EAAuD;AACrD,aAAO,KAAIG,cAAc,GAACC,gCAAnB,EAAoD,KAAKhB,GAAzD,CAAP;AACD;;AAED,QAAI,CAACE,GAAG,CAACe,WAAJ,EAAL,EAAwB;AACtB,YAAMC,OAAO,GAAG,MAAMH,cAAc,GAACI,2BAAf,CACpBT,iBADoB,EAEpBL,QAFoB,EAGpB,KAAKL,GAAL,CAASoB,gBAHW,CAAtB;;AAKA,UAAI,CAACF,OAAL,EAAc;AACZ,cAAM,IAAId,KAAJ,CAAW,8DAAX,CAAN;AACD;;AACD,aAAO,IAAP;AACD,KAlC6C,CAoC9C;;;AACA,QAAI,CAACM,iBAAiB,CAACW,qBAAvB,EAA8C;AAC5C,0BACEC,iBAAMC,MAAN,CACE,kFADF,CADF;AAKA,YAAML,OAAO,GAAG,MAAMH,cAAc,GAACI,2BAAf,CACpBT,iBADoB,EAEpBL,QAFoB,EAGpB,KAAKL,GAAL,CAASoB,gBAHW,CAAtB;;AAKA,UAAI,CAACF,OAAL,EAAc;AACZ,eAAO,KAAIH,cAAc,GAACC,gCAAnB,EAAoD,KAAKhB,GAAzD,CAAP;AACD;;AACD,aAAO,IAAP;AACD;;AAED,UAAMwB,gBAAgB,GAAG,MAAMT,cAAc,GAACU,YAAf,CAC7BvB,GAAG,CAACwB,QADyB,EAE7B,KAAK1B,GAAL,CAASoB,gBAFoB,EAG7BV,iBAH6B,CAA/B,CAtD8C,CA4D9C;;AACA,QAAI,CAACc,gBAAL,EAAuB;AACrB,aAAO,KAAIT,cAAc,GAACC,gCAAnB,EAAoD,KAAKhB,GAAzD,CAAP;AACD;;AAED,UAAMe,cAAc,GAACY,qCAAf,CACJzB,GADI,EAEJ,KAAKF,GAFD,EAGJK,QAHI,EAIJmB,gBAJI,CAAN;AAMA,WAAO,IAAP;AACD;;AA3EuD","sourcesContent":["import chalk from 'chalk';\n\nimport log from '../../log';\nimport { AppLookupParams } from '../api/IosApi';\nimport { Context, IView } from '../context';\nimport { IosDistCredentials } from '../credentials';\nimport * as iosProfileView from './IosProvisioningProfile';\n\ninterface ProvisioningProfileOptions {\n  nonInteractive?: boolean;\n  distCert: IosDistCredentials;\n}\n\nexport class SetupIosProvisioningProfile implements IView {\n  constructor(private app: AppLookupParams) {}\n\n  async open(ctx: Context): Promise<IView | null> {\n    if (!ctx.user) {\n      throw new Error(`This workflow requires you to be logged in.`);\n    }\n\n    const distCert = await ctx.ios.getDistCert(this.app);\n    if (!distCert) {\n      // dist cert should aready be created\n      // TODO: trigger dist cert creation here\n      throw new Error('There is no disttribution certificate assgined for this app');\n    }\n\n    const appCredentials = await ctx.ios.getAppCredentials(this.app);\n\n    // Try to use the profile we have on file first\n    const configuredProfile = await ctx.ios.getProvisioningProfile(this.app);\n\n    // We dont have a profile on expo servers or\n    // The configured profile is associated with some other dist cert\n    const configuredWithSameDistCert = appCredentials.distCredentialsId === distCert.id;\n    if (!configuredProfile || !configuredWithSameDistCert) {\n      return new iosProfileView.CreateOrReuseProvisioningProfile(this.app);\n    }\n\n    if (!ctx.hasAppleCtx()) {\n      const isValid = await iosProfileView.validateProfileWithoutApple(\n        configuredProfile,\n        distCert,\n        this.app.bundleIdentifier\n      );\n      if (!isValid) {\n        throw new Error(`The provisioning profile we have on file is no longer valid.`);\n      }\n      return null;\n    }\n\n    // User uploaded profiles dont have ids - do best effort validation here\n    if (!configuredProfile.provisioningProfileId) {\n      log(\n        chalk.yellow(\n          \"The provisioning profile we have on file cannot be validated on Apple's servers.\"\n        )\n      );\n      const isValid = await iosProfileView.validateProfileWithoutApple(\n        configuredProfile,\n        distCert,\n        this.app.bundleIdentifier\n      );\n      if (!isValid) {\n        return new iosProfileView.CreateOrReuseProvisioningProfile(this.app);\n      }\n      return null;\n    }\n\n    const profileFromApple = await iosProfileView.getAppleInfo(\n      ctx.appleCtx,\n      this.app.bundleIdentifier,\n      configuredProfile\n    );\n\n    // Profile can't be found on Apple servers\n    if (!profileFromApple) {\n      return new iosProfileView.CreateOrReuseProvisioningProfile(this.app);\n    }\n\n    await iosProfileView.configureAndUpdateProvisioningProfile(\n      ctx,\n      this.app,\n      distCert,\n      profileFromApple\n    );\n    return null;\n  }\n}\n"],"file":"SetupIosProvisioningProfile.js"}