{"version":3,"sources":["../../../../src/commands/eas-build/build/credentials.ts"],"names":["USING_CREDENTIALS_JSON_MSG","USING_REMOTE_CREDENTIALS_MSG","ensureCredentialsAutoAsync","provider","workflow","nonInteractive","platform","platformDisplayNames","Workflow","Managed","hasLocalAsync","CredentialsSource","LOCAL","REMOTE","Generic","hasLocal","hasRemote","hasRemoteAsync","isLocalSyncedAsync","CommandError","select","type","name","message","choices","title","value","log","chalk","bold","warn","confirm","Error","ensureCredentialsAsync","src","AUTO"],"mappings":"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","sourcesContent":["import CommandError from '../../../CommandError';\nimport { CredentialsProvider } from '../../../credentials/provider';\nimport { CredentialsSource, Workflow } from '../../../easJson';\nimport log from '../../../log';\nimport prompts from '../../../prompts';\nimport { platformDisplayNames } from '../constants';\n\nconst USING_CREDENTIALS_JSON_MSG = 'Using credentials from the local credentials.json file';\nconst USING_REMOTE_CREDENTIALS_MSG = 'Using credentials stored on the Expo servers';\n\nasync function ensureCredentialsAutoAsync(\n  provider: CredentialsProvider,\n  workflow: Workflow,\n  nonInteractive: boolean\n): Promise<CredentialsSource.LOCAL | CredentialsSource.REMOTE> {\n  const platform = platformDisplayNames[provider.platform];\n  switch (workflow) {\n    case Workflow.Managed:\n      if (await provider.hasLocalAsync()) {\n        return CredentialsSource.LOCAL;\n      } else {\n        return CredentialsSource.REMOTE;\n      }\n    case Workflow.Generic: {\n      const hasLocal = await provider.hasLocalAsync();\n      const hasRemote = await provider.hasRemoteAsync();\n      if (hasRemote && hasLocal) {\n        if (!(await provider.isLocalSyncedAsync())) {\n          if (nonInteractive) {\n            throw new CommandError(\n              'NON_INTERACTIVE',\n              `Contents of your local credentials.json for ${platform} are not the same as credentials on Expo servers. To use the desired credentials, set the \"builds.${platform}.{profile}.credentialsSource\" field in the credentials.json file to one of the following: \"local\", \"remote\".`\n            );\n          } else {\n            log(\n              `Contents of your local credentials.json for ${platform} are not the same as credentials on Expo servers`\n            );\n          }\n\n          const { select } = await prompts({\n            type: 'select',\n            name: 'select',\n            message: 'Which credentials you want to use for this build?',\n            choices: [\n              { title: 'Local credentials.json', value: CredentialsSource.LOCAL },\n              { title: 'Credentials stored on Expo servers.', value: CredentialsSource.REMOTE },\n            ],\n          });\n          return select;\n        } else {\n          return CredentialsSource.LOCAL;\n        }\n      } else if (hasLocal) {\n        log(log.chalk.bold(USING_CREDENTIALS_JSON_MSG));\n        return CredentialsSource.LOCAL;\n      } else if (hasRemote) {\n        log(log.chalk.bold(USING_REMOTE_CREDENTIALS_MSG));\n        return CredentialsSource.REMOTE;\n      } else {\n        if (nonInteractive) {\n          throw new CommandError(\n            'NON_INTERACTIVE',\n            `Credentials for this app are not configured and there is no entry in credentials.json for ${platform}. Either configure credentials.json, or launch the build without \"--non-interactive\" flag to get a prompt to generate credentials automatically.`\n          );\n        } else {\n          log.warn(\n            `Credentials for this app are not configured and there is no entry in credentials.json for ${platform}`\n          );\n        }\n\n        const { confirm } = await prompts({\n          type: 'confirm',\n          name: 'confirm',\n          message: 'Do you want to generate new credentials?',\n        });\n        if (confirm) {\n          return CredentialsSource.REMOTE;\n        } else {\n          throw new Error(`Aborting build process, credentials are not configured for ${platform}`);\n        }\n      }\n    }\n  }\n}\n\nexport async function ensureCredentialsAsync(\n  provider: CredentialsProvider,\n  workflow: Workflow,\n  src: CredentialsSource,\n  nonInteractive: boolean\n): Promise<CredentialsSource.LOCAL | CredentialsSource.REMOTE> {\n  switch (src) {\n    case CredentialsSource.LOCAL:\n      log(log.chalk.bold(USING_CREDENTIALS_JSON_MSG));\n      return CredentialsSource.LOCAL;\n    case CredentialsSource.REMOTE:\n      log(log.chalk.bold(USING_REMOTE_CREDENTIALS_MSG));\n      return CredentialsSource.REMOTE;\n    case CredentialsSource.AUTO:\n      log('Resolving credentials source (auto mode)');\n      return await ensureCredentialsAutoAsync(provider, workflow, nonInteractive);\n  }\n}\n"],"file":"credentials.js"}