{"version":3,"sources":["../../../../../src/commands/eas-build/build/builders/AndroidBuilder.ts"],"names":["hasApplyLine","content","applyLine","split","some","line","replace","AndroidBuilder","constructor","ctx","setupAsync","ensureCredentialsAsync","credentialsPrepared","secretEnvs","commandCtx","projectDir","shouldLoadCredentials","provider","AndroidCredentialsProvider","projectName","accountName","nonInteractive","skipCredentialsCheck","initAsync","credentialsSource","buildProfile","workflow","credentials","getCredentialsAsync","isProjectConfiguredAsync","androidAppDir","path","join","buildGradlePath","easGradlePath","hasEasGradleFile","fs","pathExists","buildGradleContent","readFile","applyEasGradle","hasEasGradleApply","ensureProjectConfiguredAsync","exp","isProjectConfigured","CommandError","startMessage","commitMessage","commitSuccessMessage","successMessage","configureProjectAsync","writeFile","gradleContent","intentToAdd","trim","prepareJobAsync","archiveUrl","Error","Workflow","Generic","prepareGenericJobAsync","Managed","prepareManagedJobAsync","prepareJobCommonAsync","buildCredentials","keystore","dataBase64","keystorePassword","keyAlias","keyPassword","platform","Platform","Android","projectUrl","secrets","projectRootDirectory","relative","process","cwd","type","BuildType","gradleCommand","artifactPath","releaseChannel","_buildProfile","packageJson","example","manifest","withoutCredentials"],"mappings":"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","sourcesContent":["import { Android, BuildType, Job, Platform, sanitizeJob } from '@expo/eas-build-job';\nimport fs from 'fs-extra';\nimport path from 'path';\n\nimport CommandError from '../../../../CommandError';\nimport { readSecretEnvsAsync } from '../../../../credentials/credentialsJson/read';\nimport AndroidCredentialsProvider, {\n  AndroidCredentials,\n} from '../../../../credentials/provider/AndroidCredentialsProvider';\nimport {\n  AndroidGenericBuildProfile,\n  AndroidManagedBuildProfile,\n  CredentialsSource,\n  Workflow,\n} from '../../../../easJson';\nimport { gitAddAsync, gitRootDirectory } from '../../../../git';\nimport { Builder, BuilderContext } from '../../types';\nimport {\n  configureUpdatesAndroidAsync,\n  setUpdatesVersionsAndroidAsync,\n} from '../../utils/expoUpdates';\nimport { modifyAndCommitAsync } from '../../utils/git';\nimport { ensureCredentialsAsync } from '../credentials';\nimport gradleContent from '../templates/gradleContent';\n\ninterface CommonJobProperties {\n  platform: Platform.Android;\n  projectUrl: string;\n  secrets: {\n    buildCredentials?: {\n      keystore: Android.Keystore;\n    };\n    secretEnvs?: Record<string, string>;\n  };\n}\n\nfunction hasApplyLine(content: string, applyLine: string) {\n  return (\n    content\n      .split('\\n')\n      // Check for both single and double quotes\n      .some(line => line === applyLine || line === applyLine.replace(/\"/g, \"'\"))\n  );\n}\n\nclass AndroidBuilder implements Builder<Platform.Android> {\n  private credentials?: AndroidCredentials;\n  private secretEnvs?: Record<string, string>;\n  private credentialsPrepared: boolean = false;\n\n  constructor(public readonly ctx: BuilderContext<Platform.Android>) {}\n\n  public async setupAsync(): Promise<void> {}\n\n  public async ensureCredentialsAsync(): Promise<\n    CredentialsSource.LOCAL | CredentialsSource.REMOTE | undefined\n  > {\n    this.credentialsPrepared = true;\n    this.secretEnvs = await readSecretEnvsAsync(this.ctx.commandCtx.projectDir);\n\n    if (!this.shouldLoadCredentials()) {\n      return;\n    }\n    const provider = new AndroidCredentialsProvider(\n      this.ctx.commandCtx.projectDir,\n      {\n        projectName: this.ctx.commandCtx.projectName,\n        accountName: this.ctx.commandCtx.accountName,\n      },\n      {\n        nonInteractive: this.ctx.commandCtx.nonInteractive,\n        skipCredentialsCheck: this.ctx.commandCtx.skipCredentialsCheck,\n      }\n    );\n    await provider.initAsync();\n    const credentialsSource = await ensureCredentialsAsync(\n      provider,\n      this.ctx.buildProfile.workflow,\n      this.ctx.buildProfile.credentialsSource,\n      this.ctx.commandCtx.nonInteractive\n    );\n    this.credentials = await provider.getCredentialsAsync(credentialsSource);\n    return credentialsSource;\n  }\n\n  private async isProjectConfiguredAsync(): Promise<boolean> {\n    const androidAppDir = path.join(this.ctx.commandCtx.projectDir, 'android', 'app');\n    const buildGradlePath = path.join(androidAppDir, 'build.gradle');\n    const easGradlePath = path.join(androidAppDir, 'eas-build.gradle');\n\n    const hasEasGradleFile = await fs.pathExists(easGradlePath);\n\n    const buildGradleContent = await fs.readFile(path.join(buildGradlePath), 'utf-8');\n    const applyEasGradle = 'apply from: \"./eas-build.gradle\"';\n\n    const hasEasGradleApply = hasApplyLine(buildGradleContent, applyEasGradle);\n\n    return hasEasGradleApply && hasEasGradleFile;\n  }\n\n  public async ensureProjectConfiguredAsync(): Promise<void> {\n    const { projectDir, exp, nonInteractive } = this.ctx.commandCtx;\n\n    const isProjectConfigured = await this.isProjectConfiguredAsync();\n\n    if (!isProjectConfigured) {\n      throw new CommandError(\n        'Project is not configured. Please run \"expo eas:build:init\" first to configure the project'\n      );\n    }\n\n    await modifyAndCommitAsync(\n      async () => {\n        await setUpdatesVersionsAndroidAsync({ projectDir, exp });\n      },\n      {\n        startMessage: 'Making sure runtime version is correct on Android',\n        commitMessage: 'Set runtime version in Android project',\n        commitSuccessMessage: 'Successfully committed the configuration changes',\n        successMessage: 'We updated the runtime version in your Android project',\n        nonInteractive,\n      }\n    );\n  }\n\n  public async configureProjectAsync(): Promise<void> {\n    const { projectDir, exp, nonInteractive } = this.ctx.commandCtx;\n\n    await modifyAndCommitAsync(\n      async () => {\n        const androidAppDir = path.join(projectDir, 'android', 'app');\n        const buildGradlePath = path.join(androidAppDir, 'build.gradle');\n        const easGradlePath = path.join(androidAppDir, 'eas-build.gradle');\n\n        await fs.writeFile(easGradlePath, gradleContent);\n        await gitAddAsync(easGradlePath, { intentToAdd: true });\n\n        const buildGradleContent = await fs.readFile(path.join(buildGradlePath), 'utf-8');\n        const applyEasGradle = 'apply from: \"./eas-build.gradle\"';\n\n        const hasEasGradleApply = hasApplyLine(buildGradleContent, applyEasGradle);\n\n        if (!hasEasGradleApply) {\n          await fs.writeFile(buildGradlePath, `${buildGradleContent.trim()}\\n${applyEasGradle}\\n`);\n        }\n\n        await configureUpdatesAndroidAsync({ projectDir, exp });\n      },\n      {\n        startMessage: 'Configuring the Android project',\n        commitMessage: 'Configure Android project',\n        commitSuccessMessage: 'Successfully committed the configuration changes',\n        successMessage: 'We configured your Android project to build it on the Expo servers',\n        nonInteractive,\n      }\n    );\n  }\n\n  public async prepareJobAsync(archiveUrl: string): Promise<Job> {\n    if (!this.credentialsPrepared) {\n      throw new Error('ensureCredentialsAsync should be called before prepareJobAsync');\n    }\n    if (this.ctx.buildProfile.workflow === Workflow.Generic) {\n      return sanitizeJob(await this.prepareGenericJobAsync(archiveUrl, this.ctx.buildProfile));\n    } else if (this.ctx.buildProfile.workflow === Workflow.Managed) {\n      return sanitizeJob(await this.prepareManagedJobAsync(archiveUrl, this.ctx.buildProfile));\n    } else {\n      throw new Error(\"Unknown workflow. Shouldn't happen\");\n    }\n  }\n\n  private async prepareJobCommonAsync(archiveUrl: string): Promise<Partial<CommonJobProperties>> {\n    const buildCredentials = this.credentials\n      ? {\n          buildCredentials: {\n            keystore: {\n              dataBase64: this.credentials.keystore.keystore,\n              keystorePassword: this.credentials.keystore.keystorePassword,\n              keyAlias: this.credentials.keystore.keyAlias,\n              keyPassword: this.credentials.keystore.keyPassword,\n            },\n          },\n        }\n      : {};\n\n    return {\n      platform: Platform.Android,\n      projectUrl: archiveUrl,\n      secrets: {\n        ...(this.secretEnvs ? { secretEnvs: this.secretEnvs } : {}),\n        ...buildCredentials,\n      },\n    };\n  }\n\n  private async prepareGenericJobAsync(\n    archiveUrl: string,\n    buildProfile: AndroidGenericBuildProfile\n  ): Promise<Partial<Android.GenericJob>> {\n    const projectRootDirectory = path.relative(await gitRootDirectory(), process.cwd()) || '.';\n    return {\n      ...(await this.prepareJobCommonAsync(archiveUrl)),\n      type: BuildType.Generic,\n      gradleCommand: buildProfile.gradleCommand,\n      artifactPath: buildProfile.artifactPath,\n      releaseChannel: buildProfile.releaseChannel,\n      projectRootDirectory,\n    };\n  }\n\n  private async prepareManagedJobAsync(\n    archiveUrl: string,\n    _buildProfile: AndroidManagedBuildProfile\n  ): Promise<Partial<Android.ManagedJob>> {\n    return {\n      ...(await this.prepareJobCommonAsync(archiveUrl)),\n      type: BuildType.Managed,\n      packageJson: { example: 'packageJson' },\n      manifest: { example: 'manifest' },\n    };\n  }\n\n  private shouldLoadCredentials(): boolean {\n    return (\n      this.ctx.buildProfile.workflow === Workflow.Managed ||\n      (this.ctx.buildProfile.workflow === Workflow.Generic &&\n        !this.ctx.buildProfile.withoutCredentials)\n    );\n  }\n}\n\nexport default AndroidBuilder;\n"],"file":"AndroidBuilder.js"}