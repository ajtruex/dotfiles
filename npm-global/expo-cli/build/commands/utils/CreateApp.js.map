{"version":3,"sources":["../../../src/commands/utils/CreateApp.ts"],"names":["validateName","name","test","TOLERABLE_FILES","getConflictsForDirectory","projectRoot","tolerableFiles","fs","readdirSync","filter","file","includes","assertFolderEmptyAsync","folderName","path","dirname","overwrite","conflicts","length","log","addNewLineIfNone","nested","chalk","green","newLine","Promise","all","map","conflict","remove","join","resolvePackageManager","options","packageManager","yarn","npm","PackageManager","shouldUseYarn","install","EXPO_DEBUG","getenv","boolish","installNodeDependenciesAsync","flags","silent","cwd","YarnPackageManager","version","versionAsync","nodeLinker","getConfigAsync","semver","satisfies","yarnRc","yamlString","readFileSync","error","code","config","yaml","safeLoad","warn","writeFileSync","safeDump","installAsync","NpmPackageManager","logNewSection","title","spinner","bold","setSpinner","start","getChangeDirectoryPath","cdPath","relative","process","installCocoaPodsAsync","step","platform","succeed","CocoaPodsPackageManager","isCLIInstalledAsync","text","render","installCLIAsync","nonInteractive","program","spawnOptions","e","stopAndPersist","symbol","red","message"],"mappings":"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","sourcesContent":["import * as PackageManager from '@expo/package-manager';\nimport program from 'commander';\nimport fs from 'fs-extra';\nimport getenv from 'getenv';\nimport yaml from 'js-yaml';\nimport ora from 'ora';\nimport * as path from 'path';\nimport semver from 'semver';\n\nimport log from '../../log';\n\nexport function validateName(name?: string): string | true {\n  if (typeof name !== 'string' || name === '') {\n    return 'The project name can not be empty.';\n  }\n  if (!/^[a-z0-9@.\\-_]+$/i.test(name)) {\n    return 'The project name can only contain URL-friendly characters (alphanumeric and @ . -  _)';\n  }\n  return true;\n}\n\n// Any of these files are allowed to exist in the projectRoot\nconst TOLERABLE_FILES = [\n  // System\n  '.DS_Store',\n  'Thumbs.db',\n  // Git\n  '.git',\n  '.gitattributes',\n  '.gitignore',\n  // Project\n  '.npmignore',\n  '.travis.yml',\n  'LICENSE',\n  'docs',\n  '.idea',\n  // Package manager\n  'npm-debug.log',\n  'yarn-debug.log',\n  'yarn-error.log',\n];\n\nexport function getConflictsForDirectory(\n  projectRoot: string,\n  tolerableFiles: string[] = TOLERABLE_FILES\n): string[] {\n  return fs\n    .readdirSync(projectRoot)\n    .filter((file: string) => !(/\\.iml$/.test(file) || tolerableFiles.includes(file)));\n}\n\nexport async function assertFolderEmptyAsync({\n  projectRoot,\n  folderName = path.dirname(projectRoot),\n  overwrite,\n}: {\n  projectRoot: string;\n  folderName?: string;\n  overwrite: boolean;\n}): Promise<boolean> {\n  const conflicts = getConflictsForDirectory(projectRoot);\n  if (conflicts.length) {\n    log.addNewLineIfNone();\n    log.nested(`The directory ${log.chalk.green(folderName)} has files that might be overwritten:`);\n    log.newLine();\n    for (const file of conflicts) {\n      log.nested(`  ${file}`);\n    }\n\n    if (overwrite) {\n      log.newLine();\n      log.nested(`Removing existing files from ${log.chalk.green(folderName)}`);\n      await Promise.all(conflicts.map(conflict => fs.remove(path.join(projectRoot, conflict))));\n      return true;\n    }\n\n    return false;\n  }\n  return true;\n}\n\nexport type PackageManagerName = 'npm' | 'yarn';\n\nexport function resolvePackageManager(options: {\n  yarn?: boolean;\n  npm?: boolean;\n  install?: boolean;\n}): PackageManagerName {\n  let packageManager: PackageManagerName = 'npm';\n  if (options.yarn || (!options.npm && PackageManager.shouldUseYarn())) {\n    packageManager = 'yarn';\n  } else {\n    packageManager = 'npm';\n  }\n  if (options.install) {\n    log.addNewLineIfNone();\n    log(\n      packageManager === 'yarn'\n        ? '🧶 Using Yarn to install packages. You can pass --npm to use npm instead.'\n        : '📦 Using npm to install packages.'\n    );\n    log.newLine();\n  }\n\n  return packageManager;\n}\n\nconst EXPO_DEBUG = getenv.boolish('EXPO_DEBUG', false);\n\nexport async function installNodeDependenciesAsync(\n  projectRoot: string,\n  packageManager: PackageManagerName,\n  flags: { silent: boolean } = {\n    // default to silent\n    silent: !EXPO_DEBUG,\n  }\n) {\n  const options = { cwd: projectRoot, silent: flags.silent };\n  if (packageManager === 'yarn') {\n    const yarn = new PackageManager.YarnPackageManager(options);\n    const version = await yarn.versionAsync();\n    const nodeLinker = await yarn.getConfigAsync('nodeLinker');\n    if (semver.satisfies(version, '>=2.0.0-rc.24') && nodeLinker !== 'node-modules') {\n      const yarnRc = path.join(projectRoot, '.yarnrc.yml');\n      let yamlString = '';\n      try {\n        yamlString = fs.readFileSync(yarnRc, 'utf8');\n      } catch (error) {\n        if (error.code !== 'ENOENT') {\n          throw error;\n        }\n      }\n      const config = yamlString ? yaml.safeLoad(yamlString) : {};\n      config.nodeLinker = 'node-modules';\n      !flags.silent &&\n        log.warn(\n          `Yarn v${version} detected, enabling experimental Yarn v2 support using the node-modules plugin.`\n        );\n      !flags.silent && log(`Writing ${yarnRc}...`);\n      fs.writeFileSync(yarnRc, yaml.safeDump(config));\n    }\n    await yarn.installAsync();\n  } else {\n    await new PackageManager.NpmPackageManager(options).installAsync();\n  }\n}\n\nexport function logNewSection(title: string) {\n  const spinner = ora(log.chalk.bold(title));\n  // respect loading indicators\n  log.setSpinner(spinner);\n  spinner.start();\n  return spinner;\n}\n\nexport function getChangeDirectoryPath(projectRoot: string): string {\n  const cdPath = path.relative(process.cwd(), projectRoot);\n  if (cdPath.length <= projectRoot.length) {\n    return cdPath;\n  }\n  return projectRoot;\n}\n\nexport async function installCocoaPodsAsync(projectRoot: string) {\n  log.addNewLineIfNone();\n  let step = logNewSection('Installing CocoaPods.');\n  if (process.platform !== 'darwin') {\n    step.succeed('Skipped installing CocoaPods because operating system is not on macOS.');\n    return false;\n  }\n  const packageManager = new PackageManager.CocoaPodsPackageManager({\n    cwd: path.join(projectRoot, 'ios'),\n    log,\n    silent: !EXPO_DEBUG,\n  });\n\n  if (!(await packageManager.isCLIInstalledAsync())) {\n    try {\n      // prompt user -- do you want to install cocoapods right now?\n      step.text = 'CocoaPods CLI not found in your PATH, installing it now.';\n      step.render();\n      await PackageManager.CocoaPodsPackageManager.installCLIAsync({\n        nonInteractive: program.nonInteractive,\n        spawnOptions: packageManager.options,\n      });\n      step.succeed('Installed CocoaPods CLI');\n      step = logNewSection('Running `pod install` in the `ios` directory.');\n    } catch (e) {\n      step.stopAndPersist({\n        symbol: '⚠️ ',\n        text: log.chalk.red(\n          'Unable to install the CocoaPods CLI. Continuing with project sync, you can install CocoaPods afterwards.'\n        ),\n      });\n      if (e.message) {\n        log(`- ${e.message}`);\n      }\n      return false;\n    }\n  }\n\n  try {\n    await packageManager.installAsync();\n    step.succeed('Installed pods and initialized Xcode workspace.');\n    return true;\n  } catch (e) {\n    step.stopAndPersist({\n      symbol: '⚠️ ',\n      text: log.chalk.red(\n        'Something went wrong running `pod install` in the `ios` directory. Continuing with project sync, you can debug this afterwards.'\n      ),\n    });\n    if (e.message) {\n      log(`- ${e.message}`);\n    }\n    return false;\n  }\n}\n"],"file":"CreateApp.js"}