{"version":3,"sources":["../../../src/commands/upload/IOSUploader.ts"],"names":["PLATFORM","APP_NAME_TOO_LONG_MSG","APP_NAME_QUESTION","type","name","message","validate","appName","length","LANGUAGES","IOSUploader","BaseUploader","validateOptions","options","language","includes","Error","publicUrl","UrlUtils","isHttps","CommandError","constructor","projectDir","_ensureExperienceIsValid","exp","ios","bundleIdentifier","_getPlatformSpecificOptions","appleIdCredentials","_getAppleIdCredentials","appleTeamId","_getAppleTeamId","_getAppName","otherOptions","ctx","Context","init","teamId","hasProjectContext","manifest","app","accountName","owner","user","username","projectName","slug","credentials","getAppCredentials","team","id","appleId","appleIdPassword","_exp","log","error","_askForAppName","_uploadToTheStore","platformData","buildPath","fastlane","companyName","appleCreds","itc_team_id","itcTeamId","resolveItcTeamId","updatedAppleCreds","appProduce","err","match","pilotUpload","chalk","underline"],"mappings":"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","sourcesContent":["import { ExpoConfig } from '@expo/config';\nimport { UrlUtils } from '@expo/xdl';\nimport chalk from 'chalk';\nimport pick from 'lodash/pick';\n\nimport CommandError from '../../CommandError';\nimport { authenticate, requestAppleIdCreds } from '../../appleApi';\nimport { Context } from '../../credentials/context';\nimport log from '../../log';\nimport prompt, { Question } from '../../prompt';\nimport BaseUploader, { PlatformOptions } from './BaseUploader';\nimport { runFastlaneAsync } from './utils';\n\nconst PLATFORM = 'ios';\n\nconst APP_NAME_TOO_LONG_MSG = `An app name can't be longer than 30 characters.`;\nconst APP_NAME_QUESTION: Question = {\n  type: 'input',\n  name: 'appName',\n  message: 'How would you like to name your app?',\n  validate(appName: string): string | true {\n    if (!appName) {\n      return 'Empty app name is not valid.';\n    } else if (appName.length > 30) {\n      return APP_NAME_TOO_LONG_MSG;\n    } else {\n      return true;\n    }\n  },\n};\n\nexport const LANGUAGES = [\n  'Brazilian Portuguese',\n  'Danish',\n  'Dutch',\n  'English',\n  'English_Australian',\n  'English_CA',\n  'English_UK',\n  'Finnish',\n  'French',\n  'French_CA',\n  'German',\n  'Greek',\n  'Indonesian',\n  'Italian',\n  'Japanese',\n  'Korean',\n  'Malay',\n  'Norwegian',\n  'Portuguese',\n  'Russian',\n  'Simplified Chinese',\n  'Spanish',\n  'Spanish_MX',\n  'Swedish',\n  'Thai',\n  'Traditional Chinese',\n  'Turkish',\n  'Vietnamese',\n];\n\nexport type IosPlatformOptions = PlatformOptions & {\n  appleId?: string;\n  appleIdPassword?: string;\n  appName: string;\n  language?: string;\n  appleTeamId?: string;\n  publicUrl?: string;\n  companyName?: string;\n};\n\ntype AppleCreds = Pick<IosPlatformOptions, 'appleId' | 'appleIdPassword'>;\n\ninterface AppleIdCredentials {\n  appleId: string;\n  appleIdPassword: string;\n}\n\nexport default class IOSUploader extends BaseUploader {\n  static validateOptions(options: IosPlatformOptions): void {\n    if (options.language && !LANGUAGES.includes(options.language)) {\n      throw new Error(\n        `You must specify a supported language. Run expo upload:ios --help to see the list of supported languages.`\n      );\n    }\n    if (options.publicUrl && !UrlUtils.isHttps(options.publicUrl)) {\n      throw new CommandError('INVALID_PUBLIC_URL', '--public-url must be a valid HTTPS URL.');\n    }\n  }\n\n  constructor(projectDir: string, public options: IosPlatformOptions) {\n    super(PLATFORM, projectDir, options);\n  }\n\n  _ensureExperienceIsValid(exp: ExpoConfig): void {\n    if (!exp.ios?.bundleIdentifier) {\n      throw new Error(`You must specify an iOS bundle identifier in app.json.`);\n    }\n  }\n\n  async _getPlatformSpecificOptions(): Promise<{ [key: string]: any }> {\n    const appleIdCredentials = await this._getAppleIdCredentials();\n    const appleTeamId = await this._getAppleTeamId(appleIdCredentials);\n    const appName = await this._getAppName();\n    const otherOptions = pick(this.options, ['language', 'sku', 'companyName']);\n    return {\n      ...appleIdCredentials,\n      appName,\n      ...otherOptions,\n      appleTeamId,\n    };\n  }\n\n  async _getAppleTeamId(appleIdCredentials: AppleIdCredentials): Promise<string | undefined> {\n    const ctx = new Context();\n    await ctx.init(this.projectDir);\n    let teamId;\n    if (ctx.hasProjectContext && ctx.manifest?.ios?.bundleIdentifier) {\n      const app = {\n        accountName: ctx.manifest.owner ?? ctx.user.username,\n        projectName: ctx.manifest.slug,\n        bundleIdentifier: ctx.manifest?.ios?.bundleIdentifier,\n      };\n      const credentials = await ctx.ios.getAppCredentials(app);\n      teamId = credentials?.credentials?.teamId;\n    }\n\n    if (teamId) {\n      return teamId;\n    } else {\n      const { team } = await authenticate(appleIdCredentials);\n      return team.id;\n    }\n  }\n\n  async _getAppleIdCredentials(): Promise<AppleIdCredentials> {\n    return await requestAppleIdCreds({\n      appleId: this.options.appleId,\n      appleIdPassword: this.options.appleIdPassword,\n    });\n  }\n\n  async _getAppName(): Promise<string> {\n    const appName = this.options.appName || (this._exp && this._exp.name);\n    if (!appName || appName.length > 30) {\n      if (appName && appName.length > 30) {\n        log.error(APP_NAME_TOO_LONG_MSG);\n      }\n      return await this._askForAppName();\n    } else {\n      return appName;\n    }\n  }\n\n  async _askForAppName(): Promise<string> {\n    const { appName } = await prompt(APP_NAME_QUESTION);\n    return appName;\n  }\n\n  async _uploadToTheStore(platformData: IosPlatformOptions, buildPath: string): Promise<void> {\n    const { fastlane } = this;\n    const { appleId, appleIdPassword, appName, language, appleTeamId, companyName } = platformData;\n\n    const appleCreds = { appleId, appleIdPassword, appleTeamId, companyName };\n\n    log('Resolving the ITC team ID...');\n    const { itc_team_id: itcTeamId } = await runFastlaneAsync(\n      fastlane.resolveItcTeamId,\n      [],\n      appleCreds\n    );\n    log(`ITC team ID is ${itcTeamId}`);\n    const updatedAppleCreds = {\n      ...appleCreds,\n      itcTeamId,\n    };\n\n    log('Ensuring the app exists on App Store Connect, this may take a while...');\n    try {\n      await runFastlaneAsync(\n        fastlane.appProduce,\n        [this._exp?.ios?.bundleIdentifier, appName, appleId, language],\n        updatedAppleCreds\n      );\n    } catch (err) {\n      if (err.message.match(/You must provide a company name to use on the App Store/)) {\n        log.error(\n          'You haven\\'t uploaded any app to App Store yet. Please provide your company name with --company-name \"COMPANY NAME\"'\n        );\n      }\n      throw err;\n    }\n\n    log('Uploading the app to Testflight, hold tight...');\n    await runFastlaneAsync(fastlane.pilotUpload, [buildPath, appleId], updatedAppleCreds);\n\n    log(\n      `All done! You may want to go to App Store Connect (${chalk.underline(\n        'https://appstoreconnect.apple.com'\n      )}) and share your build with your testers.`\n    );\n  }\n}\n"],"file":"IOSUploader.js"}