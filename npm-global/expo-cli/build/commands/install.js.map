{"version":3,"sources":["../../src/commands/install.ts"],"names":["installAsync","packages","options","projectRoot","info","process","cwd","error","code","log","addNewLineIfNone","message","newLine","chalk","cyan","bold","exit","packageManager","PackageManager","createForProject","npm","yarn","exp","pkg","ConfigUtils","getConfig","skipSDKVersionRequirement","dependencies","addAsync","sdkVersion","name","toLowerCase","Versions","gteSdkVersion","fs","existsSync","path","join","nodeModulesPath","bundledNativeModulesPath","projectHasModule","bundledNativeModules","JsonFile","readAsync","nativeModules","others","versionedPackages","map","arg","spec","includes","type","version","modifiedSpec","push","raw","messages","length","install","program","command","alias","helpGroup","option","description","asyncAction"],"mappings":"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","sourcesContent":["import * as ConfigUtils from '@expo/config';\nimport JsonFile from '@expo/json-file';\nimport * as PackageManager from '@expo/package-manager';\nimport { Versions } from '@expo/xdl';\nimport { Command } from 'commander';\nimport fs from 'fs';\nimport npmPackageArg from 'npm-package-arg';\nimport path from 'path';\n\nimport log from '../log';\nimport { findProjectRootAsync } from './utils/ProjectUtils';\n\nasync function installAsync(packages: string[], options: PackageManager.CreateForProjectOptions) {\n  let projectRoot: string;\n  try {\n    const info = await findProjectRootAsync(process.cwd());\n    projectRoot = info.projectRoot;\n  } catch (error) {\n    if (error.code !== 'NO_PROJECT') {\n      // An unknown error occurred.\n      throw error;\n    }\n    // This happens when an app.config exists but a package.json is not present.\n    log.addNewLineIfNone();\n    log.error(error.message);\n    log.newLine();\n    log(log.chalk.cyan(`You can create a new project with ${log.chalk.bold(`expo init`)}`));\n    log.newLine();\n    process.exit(1);\n  }\n\n  const packageManager = PackageManager.createForProject(projectRoot, {\n    npm: options.npm,\n    yarn: options.yarn,\n    log,\n  });\n\n  const { exp, pkg } = ConfigUtils.getConfig(projectRoot, { skipSDKVersionRequirement: true });\n\n  // If using `expo install` in a project without the expo package even listed\n  // in package.json, just fall through to npm/yarn.\n  //\n  if (!pkg.dependencies['expo']) {\n    return await packageManager.addAsync(...packages);\n  }\n\n  if (!exp.sdkVersion) {\n    log.addNewLineIfNone();\n    log.error(\n      `The ${log.chalk.bold(`expo`)} package was found in your ${log.chalk.bold(\n        `package.json`\n      )} but we couldn't resolve the Expo SDK version. Run ${log.chalk.bold(\n        `${packageManager.name.toLowerCase()} install`\n      )} and then try this command again.`\n    );\n    log.newLine();\n    process.exit(1);\n    return;\n  }\n\n  if (!Versions.gteSdkVersion(exp, '33.0.0')) {\n    log.addNewLineIfNone();\n    log.error(\n      `${log.chalk.bold(`expo install`)} is only available for Expo SDK version 33 or higher.`\n    );\n    log.newLine();\n    log(log.chalk.cyan(`Current version: ${log.chalk.bold(exp.sdkVersion)}`));\n    log.newLine();\n    process.exit(1);\n  }\n\n  // This shouldn't be invoked because `findProjectRootAsync` will throw if node_modules are missing.\n  if (!fs.existsSync(path.join(exp.nodeModulesPath || projectRoot, 'node_modules'))) {\n    log.addNewLineIfNone();\n    log(log.chalk.cyan(`node_modules not found, running ${packageManager.name} install command.`));\n    log.newLine();\n    await packageManager.installAsync();\n  }\n\n  const bundledNativeModulesPath = ConfigUtils.projectHasModule(\n    'expo/bundledNativeModules.json',\n    projectRoot,\n    exp\n  );\n\n  if (!bundledNativeModulesPath) {\n    log.addNewLineIfNone();\n    log.error(\n      `The dependency map ${log.chalk.bold(\n        `expo/bundledNativeModules.json`\n      )} cannot be found, please ensure you have the package \"${log.chalk\n        .bold`expo`}\" installed in your project.`\n    );\n    log.newLine();\n    process.exit(1);\n  }\n\n  const bundledNativeModules = await JsonFile.readAsync(bundledNativeModulesPath);\n\n  const nativeModules = [];\n  const others = [];\n  const versionedPackages = packages.map(arg => {\n    const spec = npmPackageArg(arg);\n    const { name } = spec;\n    if (['tag', 'version', 'range'].includes(spec.type) && name && bundledNativeModules[name]) {\n      // Unimodule packages from npm registry are modified to use the bundled version.\n      const version = bundledNativeModules[name];\n      const modifiedSpec = `${name}@${version}`;\n      nativeModules.push(modifiedSpec);\n      return modifiedSpec;\n    } else {\n      // Other packages are passed through unmodified.\n      others.push(spec.raw);\n      return spec.raw;\n    }\n  });\n  const messages = [];\n  if (nativeModules.length > 0) {\n    messages.push(\n      `${nativeModules.length} SDK ${exp.sdkVersion} compatible native ${\n        nativeModules.length === 1 ? 'module' : 'modules'\n      }`\n    );\n  }\n  if (others.length > 0) {\n    messages.push(`${others.length} other ${others.length === 1 ? 'package' : 'packages'}`);\n  }\n  log(`Installing ${messages.join(' and ')} using ${packageManager.name}.`);\n  await packageManager.addAsync(...versionedPackages);\n}\n\nexport default function install(program: Command) {\n  program\n    .command('install [packages...]')\n    .alias('add')\n    .helpGroup('core')\n    .option('--npm', 'Use npm to install dependencies. (default when package-lock.json exists)')\n    .option('--yarn', 'Use Yarn to install dependencies. (default when yarn.lock exists)')\n    .description('Install a unimodule or other package to a project')\n    .asyncAction(installAsync);\n}\n"],"file":"install.js"}