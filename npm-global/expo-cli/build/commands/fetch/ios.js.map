{"version":3,"sources":["../../../src/commands/fetch/ios.ts"],"names":["fetchIosCerts","projectDir","inProjectDir","filename","path","resolve","ctx","Context","init","bundleIdentifier","manifest","ios","Error","app","accountName","owner","user","username","projectName","slug","appCredentials","getAppCredentials","pushCredentials","getPushKey","distCredentials","getDistCert","certP12","certPassword","certPrivateSigningKey","apnsKeyId","apnsKeyP8","pushP12","pushPassword","provisioningProfile","teamId","credentials","undefined","distPath","fs","writeFile","Buffer","from","distPrivateKeyPath","apnsKeyP8Path","pushPath","provisioningProfilePath","chalk","bold","yellow","e"],"mappings":";;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;AAEA,eAAeA,aAAf,CAA6BC,UAA7B,EAAgE;AAC9D,QAAMC,YAAY,GAAIC,QAAD,IAA8BC,gBAAKC,OAAL,CAAaJ,UAAb,EAAyBE,QAAzB,CAAnD;;AACA,MAAI;AAAA;;AACF,UAAMG,GAAG,GAAG,KAAIC,kBAAJ,GAAZ;AACA,UAAMD,GAAG,CAACE,IAAJ,CAASP,UAAT,CAAN;AAEA,UAAMQ,gBAAgB,oBAAGH,GAAG,CAACI,QAAP,uEAAG,cAAcC,GAAjB,sDAAG,kBAAmBF,gBAA5C;;AACA,QAAI,CAACA,gBAAL,EAAuB;AACrB,YAAM,IAAIG,KAAJ,CACH,2IADG,CAAN;AAGD;;AAED,UAAMC,GAAG,GAAG;AACVC,MAAAA,WAAW,yBAAER,GAAG,CAACI,QAAJ,CAAaK,KAAf,qEAAwBT,GAAG,CAACU,IAAJ,CAASC,QADlC;AAEVC,MAAAA,WAAW,EAAEZ,GAAG,CAACI,QAAJ,CAAaS,IAFhB;AAGVV,MAAAA;AAHU,KAAZ;AAKA,wBACG,mCAAkCI,GAAG,CAACC,WAAY,IAAGD,GAAG,CAACK,WAAY,KAAIT,gBAAiB,GAD7F;AAGA,UAAMW,cAAc,GAAG,MAAMd,GAAG,CAACK,GAAJ,CAAQU,iBAAR,CAA0BR,GAA1B,CAA7B;AACA,UAAMS,eAAe,GAAG,MAAMhB,GAAG,CAACK,GAAJ,CAAQY,UAAR,CAAmBV,GAAnB,CAA9B;AACA,UAAMW,eAAe,GAAG,MAAMlB,GAAG,CAACK,GAAJ,CAAQc,WAAR,CAAoBZ,GAApB,CAA9B;AAEA,UAAM;AAAEa,MAAAA,OAAF;AAAWC,MAAAA,YAAX;AAAyBC,MAAAA;AAAzB,QAAmDJ,eAAnD,aAAmDA,eAAnD,cAAmDA,eAAnD,GAAsE,EAA5E;AACA,UAAM;AAAEK,MAAAA,SAAF;AAAaC,MAAAA;AAAb,QAA2BR,eAA3B,aAA2BA,eAA3B,cAA2BA,eAA3B,GAA8C,EAApD;AACA,UAAM;AAAES,MAAAA,OAAF;AAAWC,MAAAA,YAAX;AAAyBC,MAAAA,mBAAzB;AAA8CC,MAAAA;AAA9C,iCACJd,cADI,aACJA,cADI,uBACJA,cAAc,CAAEe,WADZ,yEAC2B,EADjC;;AAGA,QAAID,MAAM,KAAKE,SAAf,EAA0B;AACxB,0BAAK,wDAAuDF,MAAO,EAAnE;AACD;;AACD,QAAIR,OAAJ,EAAa;AACX,YAAMW,QAAQ,GAAGnC,YAAY,CAAE,GAAEW,GAAG,CAACK,WAAY,WAApB,CAA7B;AACA,YAAMoB,mBAAGC,SAAH,CAAaF,QAAb,EAAuBG,MAAM,CAACC,IAAP,CAAYf,OAAZ,EAAqB,QAArB,CAAvB,CAAN;AACD;;AACD,QAAIE,qBAAJ,EAA2B;AACzB,YAAMc,kBAAkB,GAAGxC,YAAY,CAAE,GAAEW,GAAG,CAACK,WAAY,wBAApB,CAAvC;AACA,YAAMoB,mBAAGC,SAAH,CAAaG,kBAAb,EAAiCd,qBAAjC,CAAN;AACD;;AACD,QAAIF,OAAO,IAAIE,qBAAf,EAAsC;AACpC,0BAAI,8CAAJ;AACD;;AACD,QAAIE,SAAJ,EAAe;AACb,YAAMa,aAAa,GAAGzC,YAAY,CAAE,GAAEW,GAAG,CAACK,WAAY,cAApB,CAAlC;AACA,YAAMoB,mBAAGC,SAAH,CAAaI,aAAb,EAA4Bb,SAA5B,CAAN;AACA,0BAAI,qCAAJ;AACD;;AACD,QAAIC,OAAJ,EAAa;AACX,YAAMa,QAAQ,GAAG1C,YAAY,CAAE,GAAEW,GAAG,CAACK,WAAY,WAApB,CAA7B;AACA,YAAMoB,mBAAGC,SAAH,CAAaK,QAAb,EAAuBJ,MAAM,CAACC,IAAP,CAAYV,OAAZ,EAAqB,QAArB,CAAvB,CAAN;AACD;;AACD,QAAIA,OAAJ,EAAa;AACX,0BAAI,sCAAJ;AACD;;AACD,QAAIE,mBAAJ,EAAyB;AACvB,YAAMY,uBAAuB,GAAGzC,gBAAKC,OAAL,CAC9BJ,UAD8B,EAE7B,GAAEY,GAAG,CAACK,WAAY,kBAFW,CAAhC;;AAIA,YAAMoB,mBAAGC,SAAH,CAAaM,uBAAb,EAAsCL,MAAM,CAACC,IAAP,CAAYR,mBAAZ,EAAiC,QAAjC,CAAtC,CAAN;AACA,0BAAI,oCAAJ;AACD;;AACD,wBAAK;;6BAGHN,YAAY,GAAGmB,iBAAMC,IAAN,CAAWpB,YAAX,CAAH,GAA8BmB,iBAAME,MAAN,CAAa,iBAAb,CAC3C;6BACwBnB,SAAS,GAAGiB,iBAAMC,IAAN,CAAWlB,SAAX,CAAH,GAA2BiB,iBAAME,MAAN,CAAa,iBAAb,CAAgC;6BAE3FhB,YAAY,GAAGc,iBAAMC,IAAN,CAAWf,YAAX,CAAH,GAA8Bc,iBAAME,MAAN,CAAa,iBAAb,CAC3C;CARD;AAUD,GAxED,CAwEE,OAAOC,CAAP,EAAU;AACV,UAAM,IAAIrC,KAAJ,CAAU,wEAAV,CAAN;AACD;;AAED,sBAAI,WAAJ;AACD;;eAEcZ,a","sourcesContent":["import chalk from 'chalk';\nimport fs from 'fs-extra';\nimport path from 'path';\n\nimport { Context } from '../../credentials/context';\nimport log from '../../log';\n\nasync function fetchIosCerts(projectDir: string): Promise<void> {\n  const inProjectDir = (filename: string): string => path.resolve(projectDir, filename);\n  try {\n    const ctx = new Context();\n    await ctx.init(projectDir);\n\n    const bundleIdentifier = ctx.manifest?.ios?.bundleIdentifier;\n    if (!bundleIdentifier) {\n      throw new Error(\n        `Your project must have a \\`bundleIdentifier\\` set in the Expo config (app.json or app.config.js).\\nSee https://expo.fyi/bundle-identifier`\n      );\n    }\n\n    const app = {\n      accountName: ctx.manifest.owner ?? ctx.user.username,\n      projectName: ctx.manifest.slug,\n      bundleIdentifier,\n    };\n    log(\n      `Retrieving iOS credentials for @${app.accountName}/${app.projectName} (${bundleIdentifier})`\n    );\n    const appCredentials = await ctx.ios.getAppCredentials(app);\n    const pushCredentials = await ctx.ios.getPushKey(app);\n    const distCredentials = await ctx.ios.getDistCert(app);\n\n    const { certP12, certPassword, certPrivateSigningKey } = distCredentials ?? {};\n    const { apnsKeyId, apnsKeyP8 } = pushCredentials ?? {};\n    const { pushP12, pushPassword, provisioningProfile, teamId } =\n      appCredentials?.credentials ?? {};\n\n    if (teamId !== undefined) {\n      log(`These credentials are associated with Apple Team ID: ${teamId}`);\n    }\n    if (certP12) {\n      const distPath = inProjectDir(`${app.projectName}_dist.p12`);\n      await fs.writeFile(distPath, Buffer.from(certP12, 'base64'));\n    }\n    if (certPrivateSigningKey) {\n      const distPrivateKeyPath = inProjectDir(`${app.projectName}_dist_cert_private.key`);\n      await fs.writeFile(distPrivateKeyPath, certPrivateSigningKey);\n    }\n    if (certP12 || certPrivateSigningKey) {\n      log('Wrote distribution cert credentials to disk.');\n    }\n    if (apnsKeyP8) {\n      const apnsKeyP8Path = inProjectDir(`${app.projectName}_apns_key.p8`);\n      await fs.writeFile(apnsKeyP8Path, apnsKeyP8);\n      log('Wrote push key credentials to disk.');\n    }\n    if (pushP12) {\n      const pushPath = inProjectDir(`${app.projectName}_push.p12`);\n      await fs.writeFile(pushPath, Buffer.from(pushP12, 'base64'));\n    }\n    if (pushP12) {\n      log('Wrote push cert credentials to disk.');\n    }\n    if (provisioningProfile) {\n      const provisioningProfilePath = path.resolve(\n        projectDir,\n        `${app.projectName}.mobileprovision`\n      );\n      await fs.writeFile(provisioningProfilePath, Buffer.from(provisioningProfile, 'base64'));\n      log('Wrote provisioning profile to disk');\n    }\n    log(`Save these important values as well:\n\nDistribution P12 password: ${\n      certPassword ? chalk.bold(certPassword) : chalk.yellow('(not available)')\n    }\nPush Key ID:               ${apnsKeyId ? chalk.bold(apnsKeyId) : chalk.yellow('(not available)')}\nPush P12 password:         ${\n      pushPassword ? chalk.bold(pushPassword) : chalk.yellow('(not available)')\n    }\n`);\n  } catch (e) {\n    throw new Error('Unable to fetch credentials for this project. Are you sure they exist?');\n  }\n\n  log('All done!');\n}\n\nexport default fetchIosCerts;\n"],"file":"ios.js"}