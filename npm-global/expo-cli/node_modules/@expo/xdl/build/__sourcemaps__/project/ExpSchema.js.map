{"version":3,"sources":["project/ExpSchema.ts"],"names":["_xdlSchemaJson","_schemaCaches","validatorFromProjectRoot","projectRoot","exp","sdkVersion","Error","schema","getSchemaAsync","validator","Schemer","validateAsync","validateAll","json","_getSchemaJSONAsync","getAssetSchemasAsync","assetSchemas","visit","node","fieldPath","meta","asset","push","properties","Object","keys","forEach","property","length","process","env","EXPONENT_UNIVERSE_DIR","JSON","parse","fs","readFileSync","path","join","toString","getConfigurationSchemaAsync","e","code","hasOwnProperty","Cacher","ApiV2","getAsync","__dirname"],"mappings":"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","sourcesContent":["import { getConfig } from '@expo/config';\nimport { JSONObject } from '@expo/json-file';\nimport Schemer from '@expo/schemer';\nimport fs from 'fs';\nimport { boolish } from 'getenv';\nimport schemaDerefSync from 'json-schema-deref-sync';\nimport path from 'path';\n\nimport ApiV2 from '../ApiV2';\nimport { Cacher } from '../tools/FsCache';\n\nexport type Schema = any;\nexport type AssetSchema = {\n  // schema: Schema;\n  fieldPath: string;\n};\n\nconst _xdlSchemaJson: { [sdkVersion: string]: Schema } = {};\nconst _schemaCaches: { [version: string]: Cacher<JSONObject> } = {};\n\nexport async function validatorFromProjectRoot(projectRoot: string): Promise<Schemer> {\n  const { exp } = getConfig(projectRoot);\n  if (!exp.sdkVersion) throw new Error(`Couldn't read local manifest`);\n  const schema = await getSchemaAsync(exp.sdkVersion);\n  const validator = new Schemer(schema);\n  return validator;\n}\n\nexport async function validateAsync(projectRoot: string) {\n  const { exp } = getConfig(projectRoot);\n  if (!exp.sdkVersion) throw new Error(`Couldn't read local manifest`);\n  const schema = await getSchemaAsync(exp.sdkVersion);\n  const validator = new Schemer(schema);\n  await validator.validateAll(exp);\n}\n\nexport async function getSchemaAsync(sdkVersion: string): Promise<Schema> {\n  const json = await _getSchemaJSONAsync(sdkVersion);\n  const schema = schemaDerefSync(json.schema);\n  return schema;\n}\n\n/**\n * Array of schema nodes that refer to assets along with their field path (eg. 'notification.icon')\n *\n * @param sdkVersion\n */\nexport async function getAssetSchemasAsync(sdkVersion: string): Promise<string[]> {\n  const schema = await getSchemaAsync(sdkVersion);\n  const assetSchemas: string[] = [];\n  const visit = (node: Schema, fieldPath: string) => {\n    if (node.meta && node.meta.asset) {\n      assetSchemas.push(fieldPath);\n    }\n    const properties = node.properties;\n    if (properties) {\n      Object.keys(properties).forEach(property =>\n        visit(properties[property], `${fieldPath}${fieldPath.length > 0 ? '.' : ''}${property}`)\n      );\n    }\n  };\n  visit(schema, '');\n\n  return assetSchemas;\n}\n\nasync function _getSchemaJSONAsync(sdkVersion: string): Promise<{ schema: Schema }> {\n  if (boolish('LOCAL_XDL_SCHEMA', false)) {\n    if (process.env.EXPONENT_UNIVERSE_DIR) {\n      return JSON.parse(\n        fs\n          .readFileSync(\n            path.join(\n              process.env.EXPONENT_UNIVERSE_DIR,\n              'server',\n              'www',\n              'xdl-schemas',\n              'UNVERSIONED-schema.json'\n            )\n          )\n          .toString()\n      );\n    } else {\n      throw new Error(`LOCAL_XDL_SCHEMA is set but EXPONENT_UNIVERSE_DIR is not.`);\n    }\n  }\n\n  if (!_xdlSchemaJson[sdkVersion]) {\n    try {\n      _xdlSchemaJson[sdkVersion] = await getConfigurationSchemaAsync(sdkVersion);\n    } catch (e) {\n      if (e.code && e.code === 'INVALID_JSON') {\n        throw new Error(`Couldn't read schema from server`);\n      } else {\n        throw e;\n      }\n    }\n  }\n\n  return _xdlSchemaJson[sdkVersion];\n}\n\nasync function getConfigurationSchemaAsync(sdkVersion: string): Promise<JSONObject> {\n  if (!_schemaCaches.hasOwnProperty(sdkVersion)) {\n    _schemaCaches[sdkVersion] = new Cacher(\n      async () => {\n        return await new ApiV2().getAsync(`project/configuration/schema/${sdkVersion}`);\n      },\n      `schema-${sdkVersion}.json`,\n      0,\n      path.join(__dirname, `../caches/schema-${sdkVersion}.json`)\n    );\n  }\n\n  return await _schemaCaches[sdkVersion].getAsync();\n}\n"],"file":"../../project/ExpSchema.js","sourceRoot":"/@expo/xdl@58.0.16/src"}