{"version":3,"sources":["Api.ts"],"names":["TIMER_DURATION","TIMEOUT","exponentClient","ApiError","ExtendableError","constructor","code","message","_rootBaseUrl","Config","api","scheme","host","_apiBaseUrl","rootBaseUrl","port","_callMethodAsync","url","method","requestBody","requestOptions","returnEntireResponse","clientId","Session","clientIdAsync","session","UserManager","getSessionAsync","skipValidationToken","process","env","headers","accessToken","sessionSecret","options","maxContentLength","MAX_CONTENT_LENGTH","data","formData","rest","convertedFormData","_convertFormDataToBuffer","getHeaders","hasOwnProperty","ConnectionStatus","isOffline","timeout","response","axios","request","Error","responseBody","responseObj","JSON","parse","e","XDLError","err","serverError","Promise","resolve","pipe","encoding","_downloadAsync","outputPath","progressFunction","retryFunction","promptShown","currentProgress","cancel","token","CancelToken","source","warningTimer","setTimeout","tmpPath","config","responseType","cancelToken","totalDownloadSize","downloadProgress","on","chunk","length","roundedProgress","Math","floor","clearTimeout","fs","createWriteStream","rename","ApiClient","setClientName","name","callMethodAsync","methodName","args","encodeURIComponent","stringify","callPathAsync","path","downloadAsync","extract","dotExpoHomeDirectory","UserSettings","join","Extract","extractAsync","removeSync"],"mappings":"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","sourcesContent":["import axios, { AxiosRequestConfig, Canceler } from 'axios';\nimport concat from 'concat-stream';\nimport ExtendableError from 'es6-error';\nimport FormData from 'form-data';\nimport fs from 'fs-extra';\nimport path from 'path';\n\nimport { MAX_CONTENT_LENGTH } from './ApiV2';\nimport Config from './Config';\nimport * as ConnectionStatus from './ConnectionStatus';\nimport * as Extract from './Extract';\nimport * as Session from './Session';\nimport UserManager from './User';\nimport UserSettings from './UserSettings';\nimport XDLError from './XDLError';\n\nconst TIMER_DURATION = 30000;\nconst TIMEOUT = 3600000;\n\nlet exponentClient = 'xdl';\n\ntype HttpMethod = 'get' | 'post' | 'put' | 'delete';\ntype RequestOptions = AxiosRequestConfig & { formData?: FormData };\n\nclass ApiError extends ExtendableError {\n  code: string;\n  readonly _isApiError = true;\n  serverError: any;\n\n  constructor(code: string, message: string) {\n    super(message);\n    this.code = code;\n  }\n}\n\n// These aren't constants because some commands switch between staging and prod\nfunction _rootBaseUrl() {\n  return `${Config.api.scheme}://${Config.api.host}`;\n}\n\nfunction _apiBaseUrl() {\n  let rootBaseUrl = _rootBaseUrl();\n  if (Config.api.port) {\n    rootBaseUrl += ':' + Config.api.port;\n  }\n  return rootBaseUrl + '/--/api';\n}\n\nasync function _callMethodAsync(\n  url: string,\n  method: HttpMethod = 'get',\n  requestBody: any,\n  requestOptions: RequestOptions,\n  returnEntireResponse = false\n) {\n  const clientId = await Session.clientIdAsync();\n  const session = await UserManager.getSessionAsync();\n  const skipValidationToken = process.env['EXPO_SKIP_MANIFEST_VALIDATION_TOKEN'];\n\n  const headers: any = {\n    'Exp-ClientId': clientId,\n    'Exponent-Client': exponentClient,\n  };\n\n  if (skipValidationToken) {\n    headers['Exp-Skip-Manifest-Validation-Token'] = skipValidationToken;\n  }\n\n  // Handle auth method, prioritizing authorization tokens before session secrets\n  if (session?.accessToken) {\n    headers['Authorization'] = `Bearer ${session.accessToken}`;\n  } else if (session?.sessionSecret) {\n    headers['Expo-Session'] = session.sessionSecret;\n  }\n\n  let options: AxiosRequestConfig = {\n    url,\n    method,\n    headers,\n    maxContentLength: MAX_CONTENT_LENGTH,\n  };\n\n  if (requestBody) {\n    options = {\n      ...options,\n      data: requestBody,\n    };\n  }\n\n  if (requestOptions.formData) {\n    const { formData, ...rest } = requestOptions;\n    const convertedFormData = await _convertFormDataToBuffer(formData);\n    const { data } = convertedFormData;\n    options.headers = {\n      ...options.headers,\n      ...formData.getHeaders(),\n    };\n    options = { ...options, data, ...rest };\n  } else {\n    options = { ...options, ...requestOptions };\n  }\n\n  if (!requestOptions.hasOwnProperty('timeout') && ConnectionStatus.isOffline()) {\n    options.timeout = 1;\n  }\n\n  const response = await axios.request(options);\n  if (!response) {\n    throw new Error('Unexpected error: Request failed.');\n  }\n  const responseBody = response.data;\n  var responseObj;\n  if (typeof responseBody === 'string') {\n    try {\n      responseObj = JSON.parse(responseBody);\n    } catch (e) {\n      throw new XDLError(\n        'INVALID_JSON',\n        'Invalid JSON returned from API: ' + e + '. Response body: ' + responseBody\n      );\n    }\n  } else {\n    responseObj = responseBody;\n  }\n  if (responseObj.err) {\n    const err = new ApiError(\n      responseObj.code || 'API_ERROR',\n      'API Response Error: ' + responseObj.err\n    );\n    err.serverError = responseObj.err;\n    throw err;\n  } else {\n    return returnEntireResponse ? response : responseObj;\n  }\n}\n\nasync function _convertFormDataToBuffer(formData: FormData): Promise<{ data: Buffer }> {\n  return new Promise(resolve => {\n    formData.pipe(concat({ encoding: 'buffer' }, data => resolve({ data })));\n  });\n}\n\ntype ProgressCallback = (progressPercentage: number) => void;\ntype RetryCallback = (cancel: Canceler) => void;\n\nasync function _downloadAsync(\n  url: string,\n  outputPath: string,\n  progressFunction?: ProgressCallback,\n  retryFunction?: RetryCallback\n) {\n  let promptShown = false;\n  let currentProgress = 0;\n\n  const { cancel, token } = axios.CancelToken.source();\n\n  let warningTimer = setTimeout(() => {\n    if (retryFunction) {\n      retryFunction(cancel);\n    }\n    promptShown = true;\n  }, TIMER_DURATION);\n\n  const tmpPath = `${outputPath}.download`;\n  const config: AxiosRequestConfig = {\n    timeout: TIMEOUT,\n    responseType: 'stream',\n    cancelToken: token,\n  };\n  const response = await axios(url, config);\n  await new Promise(resolve => {\n    const totalDownloadSize = response.data.headers['content-length'];\n    let downloadProgress = 0;\n    response.data\n      .on('data', (chunk: Buffer) => {\n        downloadProgress += chunk.length;\n        const roundedProgress = Math.floor((downloadProgress / totalDownloadSize) * 100);\n        if (currentProgress !== roundedProgress) {\n          currentProgress = roundedProgress;\n          clearTimeout(warningTimer);\n          if (!promptShown) {\n            warningTimer = setTimeout(() => {\n              if (retryFunction) {\n                retryFunction(cancel);\n              }\n              promptShown = true;\n            }, TIMER_DURATION);\n          }\n          if (progressFunction) {\n            progressFunction(roundedProgress);\n          }\n        }\n      })\n      .on('end', () => {\n        clearTimeout(warningTimer);\n        if (progressFunction && currentProgress !== 100) {\n          progressFunction(100);\n        }\n        resolve();\n      })\n      .pipe(fs.createWriteStream(tmpPath));\n  });\n  await fs.rename(tmpPath, outputPath);\n}\n\n/** @deprecated use ApiV2, got or GraphQL depending on use case. */\nexport default class ApiClient {\n  static host: string = Config.api.host;\n  static port: number = Config.api.port || 80;\n\n  static setClientName(name: string) {\n    exponentClient = name;\n  }\n\n  static async callMethodAsync(\n    methodName: string,\n    args: any,\n    method?: HttpMethod,\n    requestBody?: any,\n    requestOptions: RequestOptions = {},\n    returnEntireResponse: boolean = false\n  ) {\n    const url =\n      _apiBaseUrl() +\n      '/' +\n      encodeURIComponent(methodName) +\n      '/' +\n      encodeURIComponent(JSON.stringify(args));\n    return _callMethodAsync(url, method, requestBody, requestOptions, returnEntireResponse);\n  }\n\n  static async callPathAsync(\n    path: string,\n    method?: HttpMethod,\n    requestBody?: any,\n    requestOptions: RequestOptions = {}\n  ) {\n    const url = _rootBaseUrl() + path;\n    return _callMethodAsync(url, method, requestBody, requestOptions);\n  }\n\n  static async downloadAsync(\n    url: string,\n    outputPath: string,\n    { extract = false } = {},\n    progressFunction?: ProgressCallback,\n    retryFunction?: RetryCallback\n  ): Promise<void> {\n    if (extract) {\n      const dotExpoHomeDirectory = UserSettings.dotExpoHomeDirectory();\n      const tmpPath = path.join(dotExpoHomeDirectory, 'tmp-download-file');\n      await _downloadAsync(url, tmpPath, progressFunction);\n      await Extract.extractAsync(tmpPath, outputPath);\n      fs.removeSync(tmpPath);\n    } else {\n      await _downloadAsync(url, outputPath, progressFunction, retryFunction);\n    }\n  }\n}\n"],"file":"../Api.js","sourceRoot":"/@expo/xdl@58.0.16/src"}