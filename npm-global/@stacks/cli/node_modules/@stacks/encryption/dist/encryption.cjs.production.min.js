"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("elliptic"),t=require("randombytes"),r=require("@stacks/common"),n=require("bitcoinjs-lib"),o=require("sha.js"),i=require("ripemd160-min"),a=require("bip39");function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var u=c(t),s=c(i);function p(e,t,r,n,o,i,a){try{var c=e[i](a),u=c.value}catch(e){return void r(e)}c.done?t(u):Promise.resolve(u).then(n,o)}function f(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var i=e.apply(t,r);function a(e){p(i,n,o,a,c,"next",e)}function c(e){p(i,n,o,a,c,"throw",e)}a(void 0)}))}}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function y(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function d(e,t,r){return(d=y()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var o=new(Function.bind.apply(e,n));return r&&l(o,r.prototype),o}).apply(null,arguments)}function v(e){var t="function"==typeof Map?new Map:void 0;return(v=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return d(e,arguments,h(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),l(r,e)})(e)}function b(e,t){return e(t={exports:{}},t.exports),t.exports}var x=b((function(e){var t=function(e){var t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},o=n.iterator||"@@iterator",i=n.asyncIterator||"@@asyncIterator",a=n.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var o=Object.create((t&&t.prototype instanceof f?t:f).prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(o,i){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===o)throw i;return{value:void 0,done:!0}}for(r.method=o,r.arg=i;;){var a=r.delegate;if(a){var c=m(a,r);if(c){if(c===p)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var u=s(e,t,r);if("normal"===u.type){if(n=r.done?"completed":"suspendedYield",u.arg===p)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n="completed",r.method="throw",r.arg=u.arg)}}}(e,r,i),o}function s(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var p={};function f(){}function h(){}function l(){}var y={};y[o]=function(){return this};var d=Object.getPrototypeOf,v=d&&d(d(C([])));v&&v!==t&&r.call(v,o)&&(y=v);var b=l.prototype=f.prototype=Object.create(y);function x(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function g(e,t){var n;this._invoke=function(o,i){function a(){return new t((function(n,a){!function n(o,i,a,c){var u=s(e[o],e,i);if("throw"!==u.type){var p=u.arg,f=p.value;return f&&"object"==typeof f&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,a,c)}),(function(e){n("throw",e,a,c)})):t.resolve(f).then((function(e){p.value=e,a(p)}),(function(e){return n("throw",e,a,c)}))}c(u.arg)}(o,i,n,a)}))}return n=n?n.then(a,a):a()}}function m(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,m(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=s(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var o=n.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function C(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:S}}function S(){return{value:void 0,done:!0}}return h.prototype=b.constructor=l,l.constructor=h,h.displayName=c(l,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,l):(e.__proto__=l,c(e,a,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},x(g.prototype),g.prototype[i]=function(){return this},e.AsyncIterator=g,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new g(u(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},x(b),c(b,a,"Generator"),b[o]=function(){return this},b.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=C,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(k),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return a.type="throw",a.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],a=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var c=r.call(i,"catchLoc"),u=r.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,p):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),k(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;k(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:C(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}}));function g(){return"undefined"!=typeof crypto&&void 0!==crypto.subtle}var m='Crypto lib not found. Either the WebCrypto "crypto.subtle" or Node.js "crypto" module must be available.';function w(){return k.apply(this,arguments)}function k(){return(k=f(x.mark((function e(){var t;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!g()){e.next=4;break}return e.abrupt("return",{lib:crypto.subtle,name:"subtleCrypto"});case 4:return e.prev=4,t=require("crypto"),e.abrupt("return",{lib:t,name:"nodeCrypto"});case 9:throw e.prev=9,e.t0=e.catch(4),new Error(m);case 12:case"end":return e.stop()}}),e,null,[[4,9]])})))).apply(this,arguments)}var E=function(){function e(e){this.createHash=e}return e.prototype.digest=function(){var e=f(x.mark((function e(t,r){var n;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===r&&(r="sha256"),e.prev=1,n=this.createHash(r).update(t).digest(),e.abrupt("return",Promise.resolve(n));case 6:return e.prev=6,e.t0=e.catch(1),console.log(e.t0),console.log("Error performing "+r+" digest with Node.js 'crypto.createHash', falling back to JS implementation."),e.abrupt("return",Promise.resolve("sha256"===r?P(t):K(t)));case 11:case"end":return e.stop()}}),e,this,[[1,6]])})));return function(t,r){return e.apply(this,arguments)}}(),e}(),C=function(){function e(e){this.subtleCrypto=e}return e.prototype.digest=function(){var e=f(x.mark((function e(t,r){var n;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===r&&(r="sha256"),"sha256"!==r){e.next=5;break}n="SHA-256",e.next=10;break;case 5:if("sha512"!==r){e.next=9;break}n="SHA-512",e.next=10;break;case 9:throw new Error("Unsupported hash algorithm "+r);case 10:return e.prev=10,e.next=13,this.subtleCrypto.digest(n,t);case 13:return e.abrupt("return",Buffer.from(e.sent));case 17:return e.prev=17,e.t0=e.catch(10),console.log(e.t0),console.log("Error performing "+r+" digest with WebCrypto, falling back to JS implementation."),e.abrupt("return",Promise.resolve("sha256"===r?P(t):K(t)));case 22:case"end":return e.stop()}}),e,this,[[10,17]])})));return function(t,r){return e.apply(this,arguments)}}(),e}();function S(){return B.apply(this,arguments)}function B(){return(B=f(x.mark((function e(){var t;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,w();case 2:if("subtleCrypto"!==(t=e.sent).name){e.next=7;break}return e.abrupt("return",new C(t.lib));case 7:return e.abrupt("return",new E(t.lib.createHash));case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function P(e){var t=new o.sha256;return t.update(e),t.digest()}function K(e){var t=new o.sha512;return t.update(e),t.digest()}var L=function(){function e(){}return e.prototype.digest=function(e){var t=new s.default;t.update(e);var r=t.digest();return Array.isArray(r)?Buffer.from(r):Buffer.from(r.buffer)},e}(),O=function(){function e(e){this.nodeCryptoCreateHash=e}return e.prototype.digest=function(e){try{return this.nodeCryptoCreateHash("rmd160").update(e).digest()}catch(t){try{return this.nodeCryptoCreateHash("ripemd160").update(e).digest()}catch(r){return console.log(t),console.log("Node.js `crypto.createHash` exists but failing to digest for ripemd160, falling back to js implementation"),(new L).digest(e)}}},e}();function T(e){return(t=function(e){try{if(!require.resolve("crypto"))return!1;var t=require("crypto");return!!t&&(!e||e(t))}catch(e){return!1}}((function(e){return"function"==typeof e.createHash&&e.createHash})),t?new O(t):new L).digest(e);var t}function j(e){return e||(e=32),u.default(e)}function A(e){var t=Buffer.isBuffer(e)?e:Buffer.from(e,"hex");return n.ECPair.fromPrivateKey(t).publicKey.toString("hex")}var H=function(){function e(e){this.createHmac=e}return e.prototype.digest=function(){var e=f(x.mark((function e(t,r){var n;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.createHmac("sha256",t).update(r).digest(),e.abrupt("return",Promise.resolve(n));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),e}(),_=function(){function e(e){this.subtleCrypto=e}return e.prototype.digest=function(){var e=f(x.mark((function e(t,r){var n;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.subtleCrypto.importKey("raw",t,{name:"HMAC",hash:"SHA-256"},!0,["sign"]);case 2:return n=e.sent,e.next=5,this.subtleCrypto.sign({name:"HMAC",hash:"SHA-256"},n,r);case 5:return e.abrupt("return",Buffer.from(e.sent));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),e}();function F(){return N.apply(this,arguments)}function N(){return(N=f(x.mark((function e(){var t;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,w();case 2:if("subtleCrypto"!==(t=e.sent).name){e.next=7;break}return e.abrupt("return",new _(t.lib));case 7:return e.abrupt("return",new H(t.lib.createHmac));case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var M=function(){function e(e,t){this.createCipher=e,this.createDecipher=t}var t=e.prototype;return t.encrypt=function(){var e=f(x.mark((function e(t,r,n,o){var i,a;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("aes-128-cbc"===t||"aes-256-cbc"===t){e.next=2;break}throw new Error('Unsupported cipher algorithm "'+t+'"');case 2:return i=this.createCipher(t,r,n),a=Buffer.concat([i.update(o),i.final()]),e.abrupt("return",Promise.resolve(a));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r,n,o){return e.apply(this,arguments)}}(),t.decrypt=function(){var e=f(x.mark((function e(t,r,n,o){var i,a;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("aes-128-cbc"===t||"aes-256-cbc"===t){e.next=2;break}throw new Error('Unsupported cipher algorithm "'+t+'"');case 2:return i=this.createDecipher(t,r,n),a=Buffer.concat([i.update(o),i.final()]),e.abrupt("return",Promise.resolve(a));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r,n,o){return e.apply(this,arguments)}}(),e}(),U=function(){function e(e){this.subtleCrypto=e}var t=e.prototype;return t.encrypt=function(){var e=f(x.mark((function e(t,r,n,o){var i,a,c;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("aes-128-cbc"!==t){e.next=5;break}i="AES-CBC",a=128,e.next=11;break;case 5:if("aes-256-cbc"!==t){e.next=10;break}i="AES-CBC",a=256,e.next=11;break;case 10:throw new Error('Unsupported cipher algorithm "'+t+'"');case 11:return e.next=13,this.subtleCrypto.importKey("raw",r,{name:i,length:a},!1,["encrypt"]);case 13:return c=e.sent,e.next=16,this.subtleCrypto.encrypt({name:i,iv:n},c,o);case 16:return e.abrupt("return",Buffer.from(e.sent));case 18:case"end":return e.stop()}}),e,this)})));return function(t,r,n,o){return e.apply(this,arguments)}}(),t.decrypt=function(){var e=f(x.mark((function e(t,r,n,o){var i,a,c;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("aes-128-cbc"!==t){e.next=5;break}i="AES-CBC",a=128,e.next=11;break;case 5:if("aes-256-cbc"!==t){e.next=10;break}i="AES-CBC",a=256,e.next=11;break;case 10:throw new Error('Unsupported cipher algorithm "'+t+'"');case 11:return e.next=13,this.subtleCrypto.importKey("raw",r,{name:i,length:a},!1,["decrypt"]);case 13:return c=e.sent,e.next=16,this.subtleCrypto.decrypt({name:i,iv:n},c,o);case 16:return e.abrupt("return",Buffer.from(e.sent));case 18:case"end":return e.stop()}}),e,this)})));return function(t,r,n,o){return e.apply(this,arguments)}}(),e}();function D(){return q.apply(this,arguments)}function q(){return(q=f(x.mark((function e(){var t;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,w();case 2:if("subtleCrypto"!==(t=e.sent).name){e.next=7;break}return e.abrupt("return",new U(t.lib));case 7:return e.abrupt("return",new M(t.lib.createCipheriv,t.lib.createDecipheriv));case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function G(e){return 16*(Math.floor(e/16)+1)}function R(e){return 4*Math.ceil(e/3)}var I=new e.ec("secp256k1");function J(e,t,r){return W.apply(this,arguments)}function W(){return(W=f(x.mark((function e(t,r,n){var o;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,D();case 2:return o=e.sent,e.next=5,o.encrypt("aes-256-cbc",r,t,n);case 5:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function V(e,t,r){return Y.apply(this,arguments)}function Y(){return(Y=f(x.mark((function e(t,r,n){var o;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,D();case 2:return o=e.sent,e.next=5,o.decrypt("aes-256-cbc",r,t,n);case 5:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function z(e,t){return Q.apply(this,arguments)}function Q(){return(Q=f(x.mark((function e(t,r){return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,F();case 2:return e.abrupt("return",e.sent.digest(t,r));case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function X(e,t){if(e.length!==t.length)return!1;for(var r=0,n=0;n<e.length;n++)r|=e[n]^t[n];return 0===r}function Z(e){var t=K(e);return{encryptionKey:t.slice(0,32),hmacKey:t.slice(32)}}function $(e){var t=e.toArrayLike(Buffer,"be",32);if(32!==t.byteLength)throw new Error("Generated a 32-byte BN for encryption. Failing.");return t}function ee(e){var t={iv:"",ephemeralPK:"",mac:"",cipherText:"",wasString:!!e.wasString};return"base64"===e.cipherTextEncoding&&(t.cipherTextEncoding="base64"),{payloadValuesLength:162,payloadShell:JSON.stringify(t)}}function te(e){return{signedPayloadValuesLength:210,signedPayloadShell:JSON.stringify({signature:"",publicKey:"",cipherText:e})}}function re(e,t,r,n){return ne.apply(this,arguments)}function ne(){return(ne=f(x.mark((function e(t,r,n,o){var i,a,c,s,p,f,h,l,y,d,v,b;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=I.keyFromPublic(t,"hex").getPublic(),a=I.genKeyPair(),c=Buffer.from(a.getPublic().encodeCompressed()),s=a.derive(i),p=$(s),f=Z(p),h=u.default(16),e.next=9,J(h,f.encryptionKey,r);case 9:return l=e.sent,y=Buffer.concat([h,c,l]),e.next=13,z(f.hmacKey,y);case 13:if(d=e.sent,o&&"hex"!==o){e.next=18;break}v=l.toString("hex"),e.next=23;break;case 18:if("base64"!==o){e.next=22;break}v=l.toString("base64"),e.next=23;break;case 22:throw new Error('Unexpected cipherTextEncoding "'+o+'"');case 23:return b={iv:h.toString("hex"),ephemeralPK:c.toString("hex"),cipherText:v,mac:d.toString("hex"),wasString:!!n},o&&"hex"!==o&&(b.cipherTextEncoding=o),e.abrupt("return",b);case 26:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function oe(e,t){return ie.apply(this,arguments)}function ie(){return(ie=f(x.mark((function e(t,n){var o,i,a,c,u,s,p,f,h,l;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=I.keyFromPrivate(t,"hex"),i=null,e.prev=2,i=I.keyFromPublic(n.ephemeralPK,"hex").getPublic(),e.next=9;break;case 6:throw e.prev=6,e.t0=e.catch(2),new r.FailedDecryptionError("Unable to get public key from cipher object. You might be trying to decrypt an unencrypted object.");case 9:if(a=o.derive(i),c=$(a),u=Z(c),s=Buffer.from(n.iv,"hex"),n.cipherTextEncoding&&"hex"!==n.cipherTextEncoding){e.next=17;break}p=Buffer.from(n.cipherText,"hex"),e.next=22;break;case 17:if("base64"!==n.cipherTextEncoding){e.next=21;break}p=Buffer.from(n.cipherText,"base64"),e.next=22;break;case 21:throw new Error('Unexpected cipherTextEncoding "'+n.cipherText+'"');case 22:return f=Buffer.concat([s,Buffer.from(i.encodeCompressed()),p]),e.next=25,z(u.hmacKey,f);case 25:if(h=e.sent,X(Buffer.from(n.mac,"hex"),h)){e.next=29;break}throw new r.FailedDecryptionError("Decryption failed: failure in MAC check");case 29:return e.next=31,V(s,u.encryptionKey,p);case 31:if(l=e.sent,!n.wasString){e.next=36;break}return e.abrupt("return",l.toString());case 36:return e.abrupt("return",l);case 37:case"end":return e.stop()}}),e,null,[[2,6]])})))).apply(this,arguments)}function ae(e,t){var r=t instanceof Buffer?t:Buffer.from(t),n=I.keyFromPrivate(e,"hex"),o=A(e),i=P(r);return{signature:n.sign(i).toDER("hex"),publicKey:o}}var ce=function(){function e(e){this.nodePbkdf2=e}return e.prototype.derive=function(){var e=f(x.mark((function e(t,r,n,o,i){var a=this;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("sha512"===i||"sha256"===i){e.next=2;break}throw new Error('Unsupported digest "'+i+'" for Pbkdf2');case 2:return e.abrupt("return",new Promise((function(e,c){a.nodePbkdf2(t,r,n,o,i,(function(t,r){t&&c(t),e(r)}))})));case 3:case"end":return e.stop()}}),e)})));return function(t,r,n,o,i){return e.apply(this,arguments)}}(),e}(),ue=function(){function e(e){this.subtleCrypto=e}return e.prototype.derive=function(){var e=f(x.mark((function e(t,r,n,o,i){var a,c,u,s,p;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("sha256"!==i){e.next=4;break}a="SHA-256",e.next=9;break;case 4:if("sha512"!==i){e.next=8;break}a="SHA-512",e.next=9;break;case 8:throw new Error('Unsupported Pbkdf2 digest algorithm "'+i+'"');case 9:return u=Buffer.from(t,"utf8"),e.prev=10,e.next=13,this.subtleCrypto.importKey("raw",u,"PBKDF2",!1,["deriveBits"]);case 13:return s=e.sent,e.next=16,this.subtleCrypto.deriveBits({name:"PBKDF2",salt:r,iterations:n,hash:{name:a}},s,8*o);case 16:c=e.sent,e.next=23;break;case 19:return e.prev=19,e.t0=e.catch(10),p=new se(this.subtleCrypto),e.abrupt("return",p.derive(t,r,n,o,i));case 23:return e.abrupt("return",Buffer.from(c));case 24:case"end":return e.stop()}}),e,this,[[10,19]])})));return function(t,r,n,o,i){return e.apply(this,arguments)}}(),e}(),se=function(){function e(e){this.subtleCrypto=e}return e.prototype.derive=function(){var e=f(x.mark((function e(t,r,n,o,i){var a,c,u,s,p,f,h,l,y,d,v,b,g,m,w,k=this;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(d=function(e,t,r){return e[r>>>=0]=(t=+t)>>>24,e[r+1]=t>>>16,e[r+2]=t>>>8,e[r+3]=255&t,r+4},"sha512"===i||"sha256"===i){e.next=3;break}throw new Error('Unsupported digest "'+i+'" for Pbkdf2');case 3:a=Buffer.from(t,"utf8"),c={name:"HMAC",hash:"sha512"===i?"SHA-512":"SHA-256"},u=function(e,t){return k.subtleCrypto.importKey("raw",e,c,!0,["sign"]).then((function(e){return k.subtleCrypto.sign(c,e,t)})).then((function(e){return new Uint8Array(e)}))},s=new Uint8Array(o),p=r.length,(f=new Uint8Array(p+4)).set(r),h=0,l="sha512"===i?64:32,y=Math.ceil(o/l),v=1;case 15:if(!(v<=y)){e.next=35;break}return d(f,v,p),e.next=19,u(a,f);case 19:g=b=e.sent,m=1;case 22:if(!(m<n)){e.next=30;break}return e.next=25,u(a,g);case 25:for(g=e.sent,w=0;w<l;w++)b[w]^=g[w];case 27:m++,e.next=22;break;case 30:s.set(b.subarray(0,s.byteLength-h),h),h+=l;case 32:v++,e.next=15;break;case 35:return e.abrupt("return",Buffer.from(s.buffer));case 36:case"end":return e.stop()}}),e)})));return function(t,r,n,o,i){return e.apply(this,arguments)}}(),e}();function pe(){return fe.apply(this,arguments)}function fe(){return(fe=f(x.mark((function e(){var t;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,w();case 2:if("subtleCrypto"!==(t=e.sent).name){e.next=7;break}return e.abrupt("return",new ue(t.lib));case 7:return e.abrupt("return",new ce(t.lib.pbkdf2));case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function he(){return(he=f(x.mark((function e(t,r,n){var o,i,c,s,p,f,h,l,y,d,v,b,g;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,o=a.mnemonicToEntropy(t),e.next=9;break;case 4:throw e.prev=4,e.t0=e.catch(0),console.error("Invalid mnemonic phrase provided"),console.error(e.t0),new Error("Not a valid bip39 mnemonic");case 9:return i=Buffer.from(o,"hex"),e.next=12,pe();case 12:return c=e.sent,s=n&&n.getRandomBytes?n.getRandomBytes(16):u.default(16),e.next=16,c.derive(r,s,1e5,48,"sha512");case 16:return f=(p=e.sent).slice(0,16),h=p.slice(16,32),l=p.slice(32,48),e.next=22,D();case 22:return y=e.sent,e.next=25,y.encrypt("aes-128-cbc",f,l,i);case 25:return d=e.sent,v=Buffer.concat([s,d]),e.next=29,F();case 29:return b=e.sent,e.next=32,b.digest(h,v);case 32:return g=Buffer.concat([s,e.sent,d]),e.abrupt("return",g);case 35:case"end":return e.stop()}}),e,null,[[0,4]])})))).apply(this,arguments)}var le=function(e){var t,r;function n(){return e.apply(this,arguments)||this}return r=e,(t=n).prototype=Object.create(r.prototype),t.prototype.constructor=t,t.__proto__=r,n}(v(Error));function ye(e,t){return de.apply(this,arguments)}function de(){return(de=f(x.mark((function e(t,r){var n,o,i,c,u,s,p,f,h,l,y,d,v,b,g,m;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.slice(0,16),o=t.slice(16,48),i=t.slice(48),c=Buffer.concat([n,i]),e.next=6,pe();case 6:return u=e.sent,e.next=9,u.derive(r,n,1e5,48,"sha512");case 9:return p=(s=e.sent).slice(0,16),f=s.slice(16,32),h=s.slice(32,48),e.next=15,D();case 15:return l=e.sent,e.next=18,l.decrypt("aes-128-cbc",p,h,i);case 18:return y=e.sent,e.next=21,F();case 21:return d=e.sent,e.next=24,d.digest(f,c);case 24:return v=e.sent,e.next=27,S();case 27:return b=e.sent,e.next=30,b.digest(o);case 30:return g=e.sent,e.next=33,b.digest(v);case 33:if(g.equals(e.sent)){e.next=36;break}throw new le("Wrong password (HMAC mismatch)");case 36:e.prev=36,m=a.entropyToMnemonic(y),e.next=45;break;case 40:throw e.prev=40,e.t0=e.catch(36),console.error("Error thrown by `entropyToMnemonic`"),console.error(e.t0),new le("Wrong password (invalid plaintext)");case 45:if(a.validateMnemonic(m)){e.next=47;break}throw new le("Wrong password (invalid plaintext)");case 47:return e.abrupt("return",m);case 48:case"end":return e.stop()}}),e,null,[[36,40]])})))).apply(this,arguments)}function ve(e,t,r){return new Promise((function(n,o){r||o(new Error("The `triplesec.decrypt` function must be provided")),r({key:Buffer.from(t),data:e},(function(e,t){e?o(e):n(t)}))}))}function be(){return(be=f(x.mark((function e(t,r,n){var o;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=Buffer.isBuffer(t)?t:Buffer.from(t,"hex"),e.prev=1,e.next=4,ye(o,r);case 4:return e.abrupt("return",e.sent);case 7:if(e.prev=7,e.t0=e.catch(1),!(e.t0 instanceof le)){e.next=11;break}throw e.t0;case 11:return e.next=13,ve(o,r,n);case 13:return e.abrupt("return",e.sent.toString());case 15:case"end":return e.stop()}}),e,null,[[1,7]])})))).apply(this,arguments)}function xe(){return(xe=f(x.mark((function e(t,r){var n,o,i,a,c,u;return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((n=Object.assign({},r)).publicKey){e.next=5;break}if(n.privateKey){e.next=4;break}throw new Error("Either public key or private key must be supplied for encryption.");case 4:n.publicKey=A(n.privateKey);case 5:return i="boolean"==typeof n.wasString?n.wasString:"string"==typeof t,a="string"==typeof t?Buffer.from(t):t,e.next=9,re(n.publicKey,a,i,n.cipherTextEncoding);case 9:return c=JSON.stringify(e.sent),n.sign&&("string"==typeof n.sign?o=n.sign:o||(o=n.privateKey),u=ae(o,c),c=JSON.stringify({signature:u.signature,publicKey:u.publicKey,cipherText:c})),e.abrupt("return",c);case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}Object.defineProperty(exports,"randomBytes",{enumerable:!0,get:function(){return u.default}}),exports.NodeCryptoSha2Hash=E,exports.WebCryptoSha2Hash=C,exports.aes256CbcEncrypt=J,exports.createSha2Hash=S,exports.decryptContent=function(e,t){var r=Object.assign({},t);if(!r.privateKey)throw new Error("Private key is required for decryption.");try{var n=JSON.parse(e);return oe(r.privateKey,n)}catch(e){throw e instanceof SyntaxError?new Error("Failed to parse encrypted content JSON. The content may not be encrypted. If using getFile, try passing { decrypt: false }."):e}},exports.decryptECIES=oe,exports.decryptMnemonic=function(e,t,r){return be.apply(this,arguments)},exports.ecPairToAddress=function(e){var t=T(P(e.publicKey));return n.address.toBase58Check(t,e.network.pubKeyHash)},exports.ecPairToHexString=function(e){var t=e.privateKey.toString("hex");return e.compressed?t+"01":t},exports.eciesGetJsonStringLength=function(e){var t,r=ee(e),n=r.payloadShell,o=r.payloadValuesLength,i=G(e.contentLength);if(e.cipherTextEncoding&&"hex"!==e.cipherTextEncoding){if("base64"!==e.cipherTextEncoding)throw new Error('Unexpected cipherTextEncoding "'+e.cipherTextEncoding+'"');t=R(i)}else t=2*i;if(e.sign){var a=te(n);return a.signedPayloadShell.length+a.signedPayloadValuesLength+o+t}return n.length+o+t},exports.encryptContent=function(e,t){return xe.apply(this,arguments)},exports.encryptECIES=re,exports.encryptMnemonic=function(e,t,r){return he.apply(this,arguments)},exports.getAesCbcOutputLength=G,exports.getBase64OutputLength=R,exports.getBufferFromBN=$,exports.getCipherObjectWrapper=ee,exports.getEntropy=j,exports.getHexFromBN=function(e){var t=e.toString("hex",64);if(64===t.length)return t;if(t.length<64)return""+"0".repeat(64-t.length)+t;throw new Error("Generated a > 32-byte BN for encryption. Failing.")},exports.getPublicKeyFromPrivate=A,exports.getSignedCipherObjectWrapper=te,exports.hashCode=function(e){var t=0;if(0===e.length)return t;for(var r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t&=t;return 2147483647&t},exports.hashSha256Sync=P,exports.hashSha512Sync=K,exports.hexStringToECPair=function(e,t){var r={network:t||n.networks.bitcoin,compressed:!0};if(66===e.length){if("01"!==e.slice(64))throw new Error("Improperly formatted private-key hex string. 66-length hex usually indicates compressed key, but last byte must be == 1");return n.ECPair.fromPrivateKey(Buffer.from(e.slice(0,64),"hex"),r)}if(64===e.length)return r.compressed=!1,n.ECPair.fromPrivateKey(Buffer.from(e,"hex"),r);throw new Error("Improperly formatted private-key hex string: length should be 64 or 66.")},exports.makeECPrivateKey=function(){return n.ECPair.makeRandom({rng:j}).privateKey.toString("hex")},exports.publicKeyToAddress=function(e){var t=T(P(Buffer.isBuffer(e)?e:Buffer.from(e,"hex")));return n.address.toBase58Check(t,n.networks.bitcoin.pubKeyHash)},exports.signECDSA=ae,exports.verifyECDSA=function(e,t,r){var n=function(e){return e instanceof Buffer?e:(ArrayBuffer,Buffer.from(e))}(e),o=I.keyFromPublic(t,"hex"),i=P(n);return o.verify(i,r)};
//# sourceMappingURL=encryption.cjs.production.min.js.map
