!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("elliptic"),require("randombytes"),require("@stacks/common"),require("bitcoinjs-lib"),require("sha.js"),require("ripemd160-min"),require("bip39")):"function"==typeof define&&define.amd?define(["exports","elliptic","randombytes","@stacks/common","bitcoinjs-lib","sha.js","ripemd160-min","bip39"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["@stacks/encryption"]={},e.elliptic,e.randomBytes,e.common,e.bitcoinjsLib,e.sha_js,e.Ripemd160Polyfill,e.bip39)}(this,(function(e,t,r,n,o,i,a,c){"use strict";function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=u(r),p=u(a);function f(e,t,r,n,o,i,a){try{var c=e[i](a),u=c.value}catch(e){return void r(e)}c.done?t(u):Promise.resolve(u).then(n,o)}function h(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var i=e.apply(t,r);function a(e){f(i,n,o,a,c,"next",e)}function c(e){f(i,n,o,a,c,"throw",e)}a(void 0)}))}}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function y(e,t){return(y=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function d(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function v(e,t,r){return(v=d()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var o=new(Function.bind.apply(e,n));return r&&y(o,r.prototype),o}).apply(null,arguments)}function b(e){var t="function"==typeof Map?new Map:void 0;return(b=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return v(e,arguments,l(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),y(r,e)})(e)}function g(e,t){return e(t={exports:{}},t.exports),t.exports}var m=g((function(e){var t=function(e){var t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},o=n.iterator||"@@iterator",i=n.asyncIterator||"@@asyncIterator",a=n.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var o=Object.create((t&&t.prototype instanceof f?t:f).prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(o,i){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===o)throw i;return{value:void 0,done:!0}}for(r.method=o,r.arg=i;;){var a=r.delegate;if(a){var c=x(a,r);if(c){if(c===p)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var u=s(e,t,r);if("normal"===u.type){if(n=r.done?"completed":"suspendedYield",u.arg===p)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n="completed",r.method="throw",r.arg=u.arg)}}}(e,r,i),o}function s(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var p={};function f(){}function h(){}function l(){}var y={};y[o]=function(){return this};var d=Object.getPrototypeOf,v=d&&d(d(C([])));v&&v!==t&&r.call(v,o)&&(y=v);var b=l.prototype=f.prototype=Object.create(y);function g(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function m(e,t){var n;this._invoke=function(o,i){function a(){return new t((function(n,a){!function n(o,i,a,c){var u=s(e[o],e,i);if("throw"!==u.type){var p=u.arg,f=p.value;return f&&"object"==typeof f&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,a,c)}),(function(e){n("throw",e,a,c)})):t.resolve(f).then((function(e){p.value=e,a(p)}),(function(e){return n("throw",e,a,c)}))}c(u.arg)}(o,i,n,a)}))}return n=n?n.then(a,a):a()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=s(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var o=n.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function C(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:S}}function S(){return{value:void 0,done:!0}}return h.prototype=b.constructor=l,l.constructor=h,h.displayName=c(l,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,l):(e.__proto__=l,c(e,a,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},g(m.prototype),m.prototype[i]=function(){return this},e.AsyncIterator=m,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new m(u(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},g(b),c(b,a,"Generator"),b[o]=function(){return this},b.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=C,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(k),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return a.type="throw",a.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],a=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var c=r.call(i,"catchLoc"),u=r.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,p):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),k(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;k(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:C(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}}));function x(){return"undefined"!=typeof crypto&&void 0!==crypto.subtle}var w='Crypto lib not found. Either the WebCrypto "crypto.subtle" or Node.js "crypto" module must be available.';function k(){return E.apply(this,arguments)}function E(){return(E=h(m.mark((function e(){var t;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!x()){e.next=4;break}return e.abrupt("return",{lib:crypto.subtle,name:"subtleCrypto"});case 4:return e.prev=4,t=require("crypto"),e.abrupt("return",{lib:t,name:"nodeCrypto"});case 9:throw e.prev=9,e.t0=e.catch(4),new Error(w);case 12:case"end":return e.stop()}}),e,null,[[4,9]])})))).apply(this,arguments)}var C=function(){function e(e){this.createHash=e}return e.prototype.digest=function(){var e=h(m.mark((function e(t,r){var n;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===r&&(r="sha256"),e.prev=1,n=this.createHash(r).update(t).digest(),e.abrupt("return",Promise.resolve(n));case 6:return e.prev=6,e.t0=e.catch(1),console.log(e.t0),console.log("Error performing "+r+" digest with Node.js 'crypto.createHash', falling back to JS implementation."),e.abrupt("return",Promise.resolve("sha256"===r?K(t):L(t)));case 11:case"end":return e.stop()}}),e,this,[[1,6]])})));return function(t,r){return e.apply(this,arguments)}}(),e}(),S=function(){function e(e){this.subtleCrypto=e}return e.prototype.digest=function(){var e=h(m.mark((function e(t,r){var n;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===r&&(r="sha256"),"sha256"!==r){e.next=5;break}n="SHA-256",e.next=10;break;case 5:if("sha512"!==r){e.next=9;break}n="SHA-512",e.next=10;break;case 9:throw new Error("Unsupported hash algorithm "+r);case 10:return e.prev=10,e.next=13,this.subtleCrypto.digest(n,t);case 13:return e.abrupt("return",Buffer.from(e.sent));case 17:return e.prev=17,e.t0=e.catch(10),console.log(e.t0),console.log("Error performing "+r+" digest with WebCrypto, falling back to JS implementation."),e.abrupt("return",Promise.resolve("sha256"===r?K(t):L(t)));case 22:case"end":return e.stop()}}),e,this,[[10,17]])})));return function(t,r){return e.apply(this,arguments)}}(),e}();function B(){return P.apply(this,arguments)}function P(){return(P=h(m.mark((function e(){var t;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,k();case 2:if("subtleCrypto"!==(t=e.sent).name){e.next=7;break}return e.abrupt("return",new S(t.lib));case 7:return e.abrupt("return",new C(t.lib.createHash));case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function K(e){var t=new i.sha256;return t.update(e),t.digest()}function L(e){var t=new i.sha512;return t.update(e),t.digest()}var T=function(){function e(){}return e.prototype.digest=function(e){var t=new p.default;t.update(e);var r=t.digest();return Array.isArray(r)?Buffer.from(r):Buffer.from(r.buffer)},e}(),j=function(){function e(e){this.nodeCryptoCreateHash=e}return e.prototype.digest=function(e){try{return this.nodeCryptoCreateHash("rmd160").update(e).digest()}catch(t){try{return this.nodeCryptoCreateHash("ripemd160").update(e).digest()}catch(r){return console.log(t),console.log("Node.js `crypto.createHash` exists but failing to digest for ripemd160, falling back to js implementation"),(new T).digest(e)}}},e}();function O(e){return(t=function(e){try{if(!require.resolve("crypto"))return!1;var t=require("crypto");return!!t&&(!e||e(t))}catch(e){return!1}}((function(e){return"function"==typeof e.createHash&&e.createHash})),t?new j(t):new T).digest(e);var t}function A(e){return e||(e=32),s.default(e)}function H(e){var t=Buffer.isBuffer(e)?e:Buffer.from(e,"hex");return o.ECPair.fromPrivateKey(t).publicKey.toString("hex")}var _=function(){function e(e){this.createHmac=e}return e.prototype.digest=function(){var e=h(m.mark((function e(t,r){var n;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.createHmac("sha256",t).update(r).digest(),e.abrupt("return",Promise.resolve(n));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),e}(),F=function(){function e(e){this.subtleCrypto=e}return e.prototype.digest=function(){var e=h(m.mark((function e(t,r){var n;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.subtleCrypto.importKey("raw",t,{name:"HMAC",hash:"SHA-256"},!0,["sign"]);case 2:return n=e.sent,e.next=5,this.subtleCrypto.sign({name:"HMAC",hash:"SHA-256"},n,r);case 5:return e.abrupt("return",Buffer.from(e.sent));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),e}();function N(){return M.apply(this,arguments)}function M(){return(M=h(m.mark((function e(){var t;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,k();case 2:if("subtleCrypto"!==(t=e.sent).name){e.next=7;break}return e.abrupt("return",new F(t.lib));case 7:return e.abrupt("return",new _(t.lib.createHmac));case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var U=function(){function e(e,t){this.createCipher=e,this.createDecipher=t}var t=e.prototype;return t.encrypt=function(){var e=h(m.mark((function e(t,r,n,o){var i,a;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("aes-128-cbc"===t||"aes-256-cbc"===t){e.next=2;break}throw new Error('Unsupported cipher algorithm "'+t+'"');case 2:return i=this.createCipher(t,r,n),a=Buffer.concat([i.update(o),i.final()]),e.abrupt("return",Promise.resolve(a));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r,n,o){return e.apply(this,arguments)}}(),t.decrypt=function(){var e=h(m.mark((function e(t,r,n,o){var i,a;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("aes-128-cbc"===t||"aes-256-cbc"===t){e.next=2;break}throw new Error('Unsupported cipher algorithm "'+t+'"');case 2:return i=this.createDecipher(t,r,n),a=Buffer.concat([i.update(o),i.final()]),e.abrupt("return",Promise.resolve(a));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r,n,o){return e.apply(this,arguments)}}(),e}(),D=function(){function e(e){this.subtleCrypto=e}var t=e.prototype;return t.encrypt=function(){var e=h(m.mark((function e(t,r,n,o){var i,a,c;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("aes-128-cbc"!==t){e.next=5;break}i="AES-CBC",a=128,e.next=11;break;case 5:if("aes-256-cbc"!==t){e.next=10;break}i="AES-CBC",a=256,e.next=11;break;case 10:throw new Error('Unsupported cipher algorithm "'+t+'"');case 11:return e.next=13,this.subtleCrypto.importKey("raw",r,{name:i,length:a},!1,["encrypt"]);case 13:return c=e.sent,e.next=16,this.subtleCrypto.encrypt({name:i,iv:n},c,o);case 16:return e.abrupt("return",Buffer.from(e.sent));case 18:case"end":return e.stop()}}),e,this)})));return function(t,r,n,o){return e.apply(this,arguments)}}(),t.decrypt=function(){var e=h(m.mark((function e(t,r,n,o){var i,a,c;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("aes-128-cbc"!==t){e.next=5;break}i="AES-CBC",a=128,e.next=11;break;case 5:if("aes-256-cbc"!==t){e.next=10;break}i="AES-CBC",a=256,e.next=11;break;case 10:throw new Error('Unsupported cipher algorithm "'+t+'"');case 11:return e.next=13,this.subtleCrypto.importKey("raw",r,{name:i,length:a},!1,["decrypt"]);case 13:return c=e.sent,e.next=16,this.subtleCrypto.decrypt({name:i,iv:n},c,o);case 16:return e.abrupt("return",Buffer.from(e.sent));case 18:case"end":return e.stop()}}),e,this)})));return function(t,r,n,o){return e.apply(this,arguments)}}(),e}();function q(){return R.apply(this,arguments)}function R(){return(R=h(m.mark((function e(){var t;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,k();case 2:if("subtleCrypto"!==(t=e.sent).name){e.next=7;break}return e.abrupt("return",new D(t.lib));case 7:return e.abrupt("return",new U(t.lib.createCipheriv,t.lib.createDecipheriv));case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function G(e){return 16*(Math.floor(e/16)+1)}function I(e){return 4*Math.ceil(e/3)}var J=new t.ec("secp256k1");function W(e,t,r){return V.apply(this,arguments)}function V(){return(V=h(m.mark((function e(t,r,n){var o;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,q();case 2:return o=e.sent,e.next=5,o.encrypt("aes-256-cbc",r,t,n);case 5:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Y(e,t,r){return z.apply(this,arguments)}function z(){return(z=h(m.mark((function e(t,r,n){var o;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,q();case 2:return o=e.sent,e.next=5,o.decrypt("aes-256-cbc",r,t,n);case 5:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Q(e,t){return X.apply(this,arguments)}function X(){return(X=h(m.mark((function e(t,r){return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,N();case 2:return e.abrupt("return",e.sent.digest(t,r));case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Z(e,t){if(e.length!==t.length)return!1;for(var r=0,n=0;n<e.length;n++)r|=e[n]^t[n];return 0===r}function $(e){var t=L(e);return{encryptionKey:t.slice(0,32),hmacKey:t.slice(32)}}function ee(e){var t=e.toArrayLike(Buffer,"be",32);if(32!==t.byteLength)throw new Error("Generated a 32-byte BN for encryption. Failing.");return t}function te(e){var t={iv:"",ephemeralPK:"",mac:"",cipherText:"",wasString:!!e.wasString};return"base64"===e.cipherTextEncoding&&(t.cipherTextEncoding="base64"),{payloadValuesLength:162,payloadShell:JSON.stringify(t)}}function re(e){return{signedPayloadValuesLength:210,signedPayloadShell:JSON.stringify({signature:"",publicKey:"",cipherText:e})}}function ne(e,t,r,n){return oe.apply(this,arguments)}function oe(){return(oe=h(m.mark((function e(t,r,n,o){var i,a,c,u,p,f,h,l,y,d,v,b;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=J.keyFromPublic(t,"hex").getPublic(),a=J.genKeyPair(),c=Buffer.from(a.getPublic().encodeCompressed()),u=a.derive(i),p=ee(u),f=$(p),h=s.default(16),e.next=9,W(h,f.encryptionKey,r);case 9:return l=e.sent,y=Buffer.concat([h,c,l]),e.next=13,Q(f.hmacKey,y);case 13:if(d=e.sent,o&&"hex"!==o){e.next=18;break}v=l.toString("hex"),e.next=23;break;case 18:if("base64"!==o){e.next=22;break}v=l.toString("base64"),e.next=23;break;case 22:throw new Error('Unexpected cipherTextEncoding "'+o+'"');case 23:return b={iv:h.toString("hex"),ephemeralPK:c.toString("hex"),cipherText:v,mac:d.toString("hex"),wasString:!!n},o&&"hex"!==o&&(b.cipherTextEncoding=o),e.abrupt("return",b);case 26:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ie(e,t){return ae.apply(this,arguments)}function ae(){return(ae=h(m.mark((function e(t,r){var o,i,a,c,u,s,p,f,h,l;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=J.keyFromPrivate(t,"hex"),i=null,e.prev=2,i=J.keyFromPublic(r.ephemeralPK,"hex").getPublic(),e.next=9;break;case 6:throw e.prev=6,e.t0=e.catch(2),new n.FailedDecryptionError("Unable to get public key from cipher object. You might be trying to decrypt an unencrypted object.");case 9:if(a=o.derive(i),c=ee(a),u=$(c),s=Buffer.from(r.iv,"hex"),r.cipherTextEncoding&&"hex"!==r.cipherTextEncoding){e.next=17;break}p=Buffer.from(r.cipherText,"hex"),e.next=22;break;case 17:if("base64"!==r.cipherTextEncoding){e.next=21;break}p=Buffer.from(r.cipherText,"base64"),e.next=22;break;case 21:throw new Error('Unexpected cipherTextEncoding "'+r.cipherText+'"');case 22:return f=Buffer.concat([s,Buffer.from(i.encodeCompressed()),p]),e.next=25,Q(u.hmacKey,f);case 25:if(h=e.sent,Z(Buffer.from(r.mac,"hex"),h)){e.next=29;break}throw new n.FailedDecryptionError("Decryption failed: failure in MAC check");case 29:return e.next=31,Y(s,u.encryptionKey,p);case 31:if(l=e.sent,!r.wasString){e.next=36;break}return e.abrupt("return",l.toString());case 36:return e.abrupt("return",l);case 37:case"end":return e.stop()}}),e,null,[[2,6]])})))).apply(this,arguments)}function ce(e,t){var r=t instanceof Buffer?t:Buffer.from(t),n=J.keyFromPrivate(e,"hex"),o=H(e),i=K(r);return{signature:n.sign(i).toDER("hex"),publicKey:o}}var ue=function(){function e(e){this.nodePbkdf2=e}return e.prototype.derive=function(){var e=h(m.mark((function e(t,r,n,o,i){var a=this;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("sha512"===i||"sha256"===i){e.next=2;break}throw new Error('Unsupported digest "'+i+'" for Pbkdf2');case 2:return e.abrupt("return",new Promise((function(e,c){a.nodePbkdf2(t,r,n,o,i,(function(t,r){t&&c(t),e(r)}))})));case 3:case"end":return e.stop()}}),e)})));return function(t,r,n,o,i){return e.apply(this,arguments)}}(),e}(),se=function(){function e(e){this.subtleCrypto=e}return e.prototype.derive=function(){var e=h(m.mark((function e(t,r,n,o,i){var a,c,u,s,p;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("sha256"!==i){e.next=4;break}a="SHA-256",e.next=9;break;case 4:if("sha512"!==i){e.next=8;break}a="SHA-512",e.next=9;break;case 8:throw new Error('Unsupported Pbkdf2 digest algorithm "'+i+'"');case 9:return u=Buffer.from(t,"utf8"),e.prev=10,e.next=13,this.subtleCrypto.importKey("raw",u,"PBKDF2",!1,["deriveBits"]);case 13:return s=e.sent,e.next=16,this.subtleCrypto.deriveBits({name:"PBKDF2",salt:r,iterations:n,hash:{name:a}},s,8*o);case 16:c=e.sent,e.next=23;break;case 19:return e.prev=19,e.t0=e.catch(10),p=new pe(this.subtleCrypto),e.abrupt("return",p.derive(t,r,n,o,i));case 23:return e.abrupt("return",Buffer.from(c));case 24:case"end":return e.stop()}}),e,this,[[10,19]])})));return function(t,r,n,o,i){return e.apply(this,arguments)}}(),e}(),pe=function(){function e(e){this.subtleCrypto=e}return e.prototype.derive=function(){var e=h(m.mark((function e(t,r,n,o,i){var a,c,u,s,p,f,h,l,y,d,v,b,g,x,w,k=this;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(d=function(e,t,r){return e[r>>>=0]=(t=+t)>>>24,e[r+1]=t>>>16,e[r+2]=t>>>8,e[r+3]=255&t,r+4},"sha512"===i||"sha256"===i){e.next=3;break}throw new Error('Unsupported digest "'+i+'" for Pbkdf2');case 3:a=Buffer.from(t,"utf8"),c={name:"HMAC",hash:"sha512"===i?"SHA-512":"SHA-256"},u=function(e,t){return k.subtleCrypto.importKey("raw",e,c,!0,["sign"]).then((function(e){return k.subtleCrypto.sign(c,e,t)})).then((function(e){return new Uint8Array(e)}))},s=new Uint8Array(o),p=r.length,(f=new Uint8Array(p+4)).set(r),h=0,l="sha512"===i?64:32,y=Math.ceil(o/l),v=1;case 15:if(!(v<=y)){e.next=35;break}return d(f,v,p),e.next=19,u(a,f);case 19:g=b=e.sent,x=1;case 22:if(!(x<n)){e.next=30;break}return e.next=25,u(a,g);case 25:for(g=e.sent,w=0;w<l;w++)b[w]^=g[w];case 27:x++,e.next=22;break;case 30:s.set(b.subarray(0,s.byteLength-h),h),h+=l;case 32:v++,e.next=15;break;case 35:return e.abrupt("return",Buffer.from(s.buffer));case 36:case"end":return e.stop()}}),e)})));return function(t,r,n,o,i){return e.apply(this,arguments)}}(),e}();function fe(){return he.apply(this,arguments)}function he(){return(he=h(m.mark((function e(){var t;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,k();case 2:if("subtleCrypto"!==(t=e.sent).name){e.next=7;break}return e.abrupt("return",new se(t.lib));case 7:return e.abrupt("return",new ue(t.lib.pbkdf2));case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function le(){return(le=h(m.mark((function e(t,r,n){var o,i,a,u,p,f,h,l,y,d,v,b,g;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,o=c.mnemonicToEntropy(t),e.next=9;break;case 4:throw e.prev=4,e.t0=e.catch(0),console.error("Invalid mnemonic phrase provided"),console.error(e.t0),new Error("Not a valid bip39 mnemonic");case 9:return i=Buffer.from(o,"hex"),e.next=12,fe();case 12:return a=e.sent,u=n&&n.getRandomBytes?n.getRandomBytes(16):s.default(16),e.next=16,a.derive(r,u,1e5,48,"sha512");case 16:return f=(p=e.sent).slice(0,16),h=p.slice(16,32),l=p.slice(32,48),e.next=22,q();case 22:return y=e.sent,e.next=25,y.encrypt("aes-128-cbc",f,l,i);case 25:return d=e.sent,v=Buffer.concat([u,d]),e.next=29,N();case 29:return b=e.sent,e.next=32,b.digest(h,v);case 32:return g=Buffer.concat([u,e.sent,d]),e.abrupt("return",g);case 35:case"end":return e.stop()}}),e,null,[[0,4]])})))).apply(this,arguments)}var ye=function(e){var t,r;function n(){return e.apply(this,arguments)||this}return r=e,(t=n).prototype=Object.create(r.prototype),t.prototype.constructor=t,t.__proto__=r,n}(b(Error));function de(e,t){return ve.apply(this,arguments)}function ve(){return(ve=h(m.mark((function e(t,r){var n,o,i,a,u,s,p,f,h,l,y,d,v,b,g,x;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.slice(0,16),o=t.slice(16,48),i=t.slice(48),a=Buffer.concat([n,i]),e.next=6,fe();case 6:return u=e.sent,e.next=9,u.derive(r,n,1e5,48,"sha512");case 9:return p=(s=e.sent).slice(0,16),f=s.slice(16,32),h=s.slice(32,48),e.next=15,q();case 15:return l=e.sent,e.next=18,l.decrypt("aes-128-cbc",p,h,i);case 18:return y=e.sent,e.next=21,N();case 21:return d=e.sent,e.next=24,d.digest(f,a);case 24:return v=e.sent,e.next=27,B();case 27:return b=e.sent,e.next=30,b.digest(o);case 30:return g=e.sent,e.next=33,b.digest(v);case 33:if(g.equals(e.sent)){e.next=36;break}throw new ye("Wrong password (HMAC mismatch)");case 36:e.prev=36,x=c.entropyToMnemonic(y),e.next=45;break;case 40:throw e.prev=40,e.t0=e.catch(36),console.error("Error thrown by `entropyToMnemonic`"),console.error(e.t0),new ye("Wrong password (invalid plaintext)");case 45:if(c.validateMnemonic(x)){e.next=47;break}throw new ye("Wrong password (invalid plaintext)");case 47:return e.abrupt("return",x);case 48:case"end":return e.stop()}}),e,null,[[36,40]])})))).apply(this,arguments)}function be(e,t,r){return new Promise((function(n,o){r||o(new Error("The `triplesec.decrypt` function must be provided")),r({key:Buffer.from(t),data:e},(function(e,t){e?o(e):n(t)}))}))}function ge(){return(ge=h(m.mark((function e(t,r,n){var o;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=Buffer.isBuffer(t)?t:Buffer.from(t,"hex"),e.prev=1,e.next=4,de(o,r);case 4:return e.abrupt("return",e.sent);case 7:if(e.prev=7,e.t0=e.catch(1),!(e.t0 instanceof ye)){e.next=11;break}throw e.t0;case 11:return e.next=13,be(o,r,n);case 13:return e.abrupt("return",e.sent.toString());case 15:case"end":return e.stop()}}),e,null,[[1,7]])})))).apply(this,arguments)}function me(){return(me=h(m.mark((function e(t,r){var n,o,i,a,c,u;return m.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((n=Object.assign({},r)).publicKey){e.next=5;break}if(n.privateKey){e.next=4;break}throw new Error("Either public key or private key must be supplied for encryption.");case 4:n.publicKey=H(n.privateKey);case 5:return i="boolean"==typeof n.wasString?n.wasString:"string"==typeof t,a="string"==typeof t?Buffer.from(t):t,e.next=9,ne(n.publicKey,a,i,n.cipherTextEncoding);case 9:return c=JSON.stringify(e.sent),n.sign&&("string"==typeof n.sign?o=n.sign:o||(o=n.privateKey),u=ce(o,c),c=JSON.stringify({signature:u.signature,publicKey:u.publicKey,cipherText:c})),e.abrupt("return",c);case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}Object.defineProperty(e,"randomBytes",{enumerable:!0,get:function(){return s.default}}),e.NodeCryptoSha2Hash=C,e.WebCryptoSha2Hash=S,e.aes256CbcEncrypt=W,e.createSha2Hash=B,e.decryptContent=function(e,t){var r=Object.assign({},t);if(!r.privateKey)throw new Error("Private key is required for decryption.");try{var n=JSON.parse(e);return ie(r.privateKey,n)}catch(e){throw e instanceof SyntaxError?new Error("Failed to parse encrypted content JSON. The content may not be encrypted. If using getFile, try passing { decrypt: false }."):e}},e.decryptECIES=ie,e.decryptMnemonic=function(e,t,r){return ge.apply(this,arguments)},e.ecPairToAddress=function(e){var t=O(K(e.publicKey));return o.address.toBase58Check(t,e.network.pubKeyHash)},e.ecPairToHexString=function(e){var t=e.privateKey.toString("hex");return e.compressed?t+"01":t},e.eciesGetJsonStringLength=function(e){var t,r=te(e),n=r.payloadShell,o=r.payloadValuesLength,i=G(e.contentLength);if(e.cipherTextEncoding&&"hex"!==e.cipherTextEncoding){if("base64"!==e.cipherTextEncoding)throw new Error('Unexpected cipherTextEncoding "'+e.cipherTextEncoding+'"');t=I(i)}else t=2*i;if(e.sign){var a=re(n);return a.signedPayloadShell.length+a.signedPayloadValuesLength+o+t}return n.length+o+t},e.encryptContent=function(e,t){return me.apply(this,arguments)},e.encryptECIES=ne,e.encryptMnemonic=function(e,t,r){return le.apply(this,arguments)},e.getAesCbcOutputLength=G,e.getBase64OutputLength=I,e.getBufferFromBN=ee,e.getCipherObjectWrapper=te,e.getEntropy=A,e.getHexFromBN=function(e){var t=e.toString("hex",64);if(64===t.length)return t;if(t.length<64)return""+"0".repeat(64-t.length)+t;throw new Error("Generated a > 32-byte BN for encryption. Failing.")},e.getPublicKeyFromPrivate=H,e.getSignedCipherObjectWrapper=re,e.hashCode=function(e){var t=0;if(0===e.length)return t;for(var r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t&=t;return 2147483647&t},e.hashSha256Sync=K,e.hashSha512Sync=L,e.hexStringToECPair=function(e,t){var r={network:t||o.networks.bitcoin,compressed:!0};if(66===e.length){if("01"!==e.slice(64))throw new Error("Improperly formatted private-key hex string. 66-length hex usually indicates compressed key, but last byte must be == 1");return o.ECPair.fromPrivateKey(Buffer.from(e.slice(0,64),"hex"),r)}if(64===e.length)return r.compressed=!1,o.ECPair.fromPrivateKey(Buffer.from(e,"hex"),r);throw new Error("Improperly formatted private-key hex string: length should be 64 or 66.")},e.makeECPrivateKey=function(){return o.ECPair.makeRandom({rng:A}).privateKey.toString("hex")},e.publicKeyToAddress=function(e){var t=O(K(Buffer.isBuffer(e)?e:Buffer.from(e,"hex")));return o.address.toBase58Check(t,o.networks.bitcoin.pubKeyHash)},e.signECDSA=ce,e.verifyECDSA=function(e,t,r){var n=function(e){return e instanceof Buffer?e:(ArrayBuffer,Buffer.from(e))}(e),o=J.keyFromPublic(t,"hex"),i=K(n);return o.verify(i,r)},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=encryption.umd.production.min.js.map
