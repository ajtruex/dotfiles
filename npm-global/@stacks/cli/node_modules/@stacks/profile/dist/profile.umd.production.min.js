!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("bitcoinjs-lib"),require("jsontokens"),require("@stacks/common"),require("@stacks/encryption"),require("zone-file"),require("schema-inspector")):"function"==typeof define&&define.amd?define(["exports","bitcoinjs-lib","jsontokens","@stacks/common","@stacks/encryption","zone-file","schema-inspector"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self)["@stacks/profile"]={},e.bitcoinjsLib,e.jsontokens,e.common,e.encryption,e.zoneFile,e.inspector)}(this,(function(e,r,t,n,i,o,a){"use strict";function s(e,r,i,o,a,s,u){if(void 0===a&&(a="ES256K"),void 0===s&&(s=new Date),void 0===u&&(u=n.nextYear()),"ES256K"!==a)throw new Error("Signing algorithm not supported");var l=t.SECP256K1Client.derivePublicKey(r);i||(i={publicKey:l}),o||(o={publicKey:l});var c=new t.TokenSigner(a,r),f={jti:n.makeUUID4(),iat:s.toISOString(),exp:u.toISOString(),subject:i,issuer:o,claim:e};return c.sign(f)}function u(e,n){var o=t.decodeToken(e),a=o.payload;if("string"==typeof a)throw new Error("Unexpected token payload type of string");if(!a.hasOwnProperty("subject")||!a.subject)throw new Error("Token doesn't have a subject");if(!a.subject.hasOwnProperty("publicKey"))throw new Error("Token doesn't have a subject public key");if(!a.hasOwnProperty("issuer")||!a.issuer)throw new Error("Token doesn't have an issuer");if(!a.issuer.hasOwnProperty("publicKey"))throw new Error("Token doesn't have an issuer public key");if(!a.hasOwnProperty("claim"))throw new Error("Token doesn't have a claim");var s=a.issuer.publicKey,u=Buffer.from(s,"hex"),l=r.ECPair.fromPublicKey(u,{compressed:!0}),c=i.ecPairToAddress(l),f=r.ECPair.fromPublicKey(u,{compressed:!1}),p=i.ecPairToAddress(f);if(n===s);else if(n===c);else if(n!==p)throw new Error("Token issuer public key does not match the verifying value");var h=new t.TokenVerifier(o.header.alg,s);if(!h)throw new Error("Invalid token verifier");if(!h.verify(e))throw new Error("Token verification failed");return o}function l(e,r){var n;void 0===r&&(r=null);var i={};if((n=r?u(e,r):t.decodeToken(e)).hasOwnProperty("payload")){var o=n.payload;if("string"==typeof o)throw new Error("Unexpected token payload type of string");o.hasOwnProperty("claim")&&(i=o.claim)}return i}function c(e,r){var t;return r.proof&&r.proof.url&&(t=r.proof.url),{"@type":"Account",service:e,identifier:r.username,proofType:"http",proofUrl:t}}var f={type:"object",properties:{"@context":{type:"string",optional:!0},"@type":{type:"string"}}},p=function(){function e(e){void 0===e&&(e={}),this._profile=Object.assign({},{"@context":"http://schema.org/"},e)}var r=e.prototype;return r.toJSON=function(){return Object.assign({},this._profile)},r.toToken=function(e){return s(this.toJSON(),e)},e.validateSchema=function(e,r){return void 0===r&&(r=!1),f.strict=r,a.validate(f,e)},e.fromToken=function(r,t){return void 0===t&&(t=null),new e(l(r,t))},e.makeZoneFile=function(e,r){return d(e,r)},e}(),h=function(e){var r,t;function n(r){var t;return void 0===r&&(r={}),(t=e.call(this,r)||this)._profile=Object.assign({},{"@type":"Person"},t._profile),t}t=e,(r=n).prototype=Object.create(t.prototype),r.prototype.constructor=r,r.__proto__=t,n.validateSchema=function(e,r){return a.validate(f,e)},n.fromToken=function(e,r){return void 0===r&&(r=null),new n(l(e,r))},n.fromLegacyFormat=function(e){return new n(function(e){var r={"@type":"Person"};if(e){e.name&&e.name.formatted&&(r.name=e.name.formatted),e.bio&&(r.description=e.bio),e.location&&e.location.formatted&&(r.address={"@type":"PostalAddress",addressLocality:e.location.formatted});var t=[];e.avatar&&e.avatar.url&&t.push({"@type":"ImageObject",name:"avatar",contentUrl:e.avatar.url}),e.cover&&e.cover.url&&t.push({"@type":"ImageObject",name:"cover",contentUrl:e.cover.url}),t.length&&(r.image=t),e.website&&(r.website=[{"@type":"WebSite",url:e.website}]);var n=[];e.bitcoin&&e.bitcoin.address&&n.push({"@type":"Account",role:"payment",service:"bitcoin",identifier:e.bitcoin.address}),e.twitter&&e.twitter.username&&n.push(c("twitter",e.twitter)),e.facebook&&e.facebook.username&&n.push(c("facebook",e.facebook)),e.github&&e.github.username&&n.push(c("github",e.github)),e.auth&&e.auth.length>0&&e.auth[0]&&e.auth[0].publicKeychain&&n.push({"@type":"Account",role:"key",service:"bip32",identifier:e.auth[0].publicKeychain}),e.pgp&&e.pgp.url&&n.push({"@type":"Account",role:"key",service:"pgp",identifier:e.pgp.fingerprint,contentUrl:e.pgp.url}),r.account=n}return r}(e))};var i=n.prototype;return i.toJSON=function(){return{profile:this.profile(),name:this.name(),givenName:this.givenName(),familyName:this.familyName(),description:this.description(),avatarUrl:this.avatarUrl(),verifiedAccounts:this.verifiedAccounts(),address:this.address(),birthDate:this.birthDate(),connections:this.connections(),organizations:this.organizations()}},i.profile=function(){return Object.assign({},this._profile)},i.name=function(){return function(e){if(!e)return null;var r=null;return e.name?r=e.name:(e.givenName||e.familyName)&&(r="",e.givenName&&(r=e.givenName),e.familyName&&(r+=" "+e.familyName)),r}(this.profile())},i.givenName=function(){return function(e){if(!e)return null;var r=null;return e.givenName?r=e.givenName:e.name&&(r=e.name.split(" ").slice(0,-1).join(" ")),r}(this.profile())},i.familyName=function(){return function(e){if(!e)return null;var r=null;return e.familyName?r=e.familyName:e.name&&(r=e.name.split(" ").pop()),r}(this.profile())},i.description=function(){return function(e){if(!e)return null;var r=null;return e.description&&(r=e.description),r}(this.profile())},i.avatarUrl=function(){return function(e){if(!e)return null;var r=null;return e.image&&e.image.map((function(e){return"avatar"===e.name?r=e.contentUrl:null})),r}(this.profile())},i.verifiedAccounts=function(e){return function(e,r){if(!e)return null;var t=[];return e.hasOwnProperty("account")&&r&&e.account.map((function(e){var n=!1,i=null;return r.map((function(r){return r.hasOwnProperty("proof_url")&&(r.proofUrl=r.proof_url),!(!r.valid||r.service!==e.service||r.identifier!==e.identifier||!r.proofUrl||(n=!0,i=r.proofUrl,0))})),n?(e.proofUrl=i,t.push(e),e):null})),t}(this.profile(),e)},i.address=function(){return function(e){if(!e)return null;var r=null;if(e.hasOwnProperty("address")){var t=[];e.address.hasOwnProperty("streetAddress")&&t.push(e.address.streetAddress),e.address.hasOwnProperty("addressLocality")&&t.push(e.address.addressLocality),e.address.hasOwnProperty("postalCode")&&t.push(e.address.postalCode),e.address.hasOwnProperty("addressCountry")&&t.push(e.address.addressCountry),t.length&&(r=t.join(", "))}return r}(this.profile())},i.birthDate=function(){return function(e){if(!e)return null;var r=null;if(e.hasOwnProperty("birthDate")){var t=new Date(e.birthDate);r=["January","February","March","April","May","June","July","August","September","October","November","December"][t.getMonth()]+" "+t.getDate()+", "+t.getFullYear()}return r}(this.profile())},i.connections=function(){return function(e){if(!e)return null;var r=[];return e.hasOwnProperty("knows")&&(r=e.knows),r}(this.profile())},i.organizations=function(){return(e=this.profile())?e.hasOwnProperty("worksFor")?e.worksFor:[]:null;var e},n}(p);function d(e,r){if(!r.includes("://"))throw new Error("Invalid token file url");var t=r.split("://")[0],n=r.split("://")[1].split("/"),i=n[0],a="/"+n.slice(1).join("/");return o.makeZoneFile({$origin:e,$ttl:3600,uri:[{name:"_http._tcp",priority:10,weight:1,target:t+"://"+i+a}]},"{$origin}\n{$ttl}\n{uri}\n")}function v(e){if(!e.hasOwnProperty("uri"))return null;if(!Array.isArray(e.uri))return null;if(e.uri.length<1)return null;var r=e.uri[0];if(!r.hasOwnProperty("target"))return null;var t=r.target;return t.startsWith("https")||t.startsWith("http")||(t="https://"+t),t}e.Person=h,e.Profile=p,e.extractProfile=l,e.getTokenFileUrl=v,e.makeProfileZoneFile=d,e.resolveZoneFileToPerson=function(e,r,t){var i=null;try{if(!(i=o.parseZoneFile(e)).hasOwnProperty("$origin"))throw i=null,new Error("zone file is missing an origin")}catch(e){console.error(e)}var a=null;if(i&&Object.keys(i).length>0)(a=v(i))?n.fetchPrivate(a).then((function(e){return e.text()})).then((function(e){return JSON.parse(e)})).then((function(e){var n=l(e[0].token,r);t(n)})).catch((function(e){console.warn(e)})):(console.warn("Token file url not found"),t({}));else{var s=null;try{s=JSON.parse(e),s=h.fromLegacyFormat(s).profile()}catch(e){console.warn(e)}t(s)}},e.resolveZoneFileToProfile=function(e,r){return new Promise((function(t,i){var a=null;try{(a=o.parseZoneFile(e)).hasOwnProperty("$origin")||(a=null)}catch(e){i(e)}var s=null;if(a&&Object.keys(a).length>0)(s=v(a))?n.fetchPrivate(s).then((function(e){return e.text()})).then((function(e){return JSON.parse(e)})).then((function(e){var n=l(e[0].token,r);t(n)})).catch((function(e){n.Logger.error("resolveZoneFileToProfile: error fetching token file "+s+": "+e),i(e)})):(n.Logger.debug("Token file url not found. Resolving to blank profile."),t({}));else{var u=null;try{u=JSON.parse(e),u=h.fromLegacyFormat(u).profile()}catch(e){i(e)}t(u)}}))},e.signProfileToken=s,e.verifyProfileToken=u,e.wrapProfileToken=function(e){return{token:e,decodedToken:t.decodeToken(e)}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=profile.umd.production.min.js.map
