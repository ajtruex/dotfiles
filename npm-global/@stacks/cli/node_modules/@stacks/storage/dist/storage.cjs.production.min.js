"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("bitcoinjs-lib"),t=require("jsontokens"),r=require("@stacks/encryption"),n=require("@stacks/common"),a=require("@stacks/auth");function o(e,t,r,n,a,o,i){try{var s=e[o](i),u=s.value}catch(e){return void r(e)}s.done?t(u):Promise.resolve(u).then(n,a)}function i(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var i=e.apply(t,r);function s(e){o(i,n,a,s,u,"next",e)}function u(e){o(i,n,a,s,u,"throw",e)}s(void 0)}))}}function s(e,t){return e(t={exports:{}},t.exports),t.exports}var u=s((function(e){var t=function(e){var t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var a=Object.create((t&&t.prototype instanceof p?t:p).prototype),o=new S(n||[]);return a._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===f)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var u=c(e,t,r);if("normal"===u.type){if(n=r.done?"completed":"suspendedYield",u.arg===f)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n="completed",r.method="throw",r.arg=u.arg)}}}(e,r,o),a}function c(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var f={};function p(){}function h(){}function l(){}var d={};d[a]=function(){return this};var g=Object.getPrototypeOf,y=g&&g(g(E([])));y&&y!==t&&r.call(y,a)&&(d=y);var b=l.prototype=p.prototype=Object.create(d);function v(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function x(e,t){var n;this._invoke=function(a,o){function i(){return new t((function(n,i){!function n(a,o,i,s){var u=c(e[a],e,o);if("throw"!==u.type){var f=u.arg,p=f.value;return p&&"object"==typeof p&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(p).then((function(e){f.value=e,i(f)}),(function(e){return n("throw",e,i,s)}))}s(u.arg)}(a,o,n,i)}))}return n=n?n.then(i,i):i()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return f;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return f}var n=c(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,f;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,f):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,f)}function m(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(m,this),this.reset(!0)}function E(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=b.constructor=l,l.constructor=h,h.displayName=s(l,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,l):(e.__proto__=l,s(e,i,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},v(x.prototype),x.prototype[o]=function(){return this},e.AsyncIterator=x,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new x(u(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},v(b),s(b,i,"Generator"),b[a]=function(){return this},b.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=E,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(k),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),u=r.call(o,"finallyLoc");if(s&&u){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,f):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),f},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),k(r),f}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;k(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:E(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),f}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}}));function c(e,t,r,n,a,o,i){return f.apply(this,arguments)}function f(){return(f=i(u.mark((function e(t,r,a,o,i,s,c){var f,p;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===o&&(o="application/octet-stream"),void 0===i&&(i=!0),n.Logger.debug("uploadToGaiaHub: uploading "+t+" to "+a.server),f={"Content-Type":o,Authorization:"bearer "+a.token},c||(i?f["If-None-Match"]="*":s&&(f["If-Match"]=s)),e.next=7,n.fetchPrivate(a.server+"/store/"+a.address+"/"+t,{method:"POST",headers:f,body:r});case 7:if((p=e.sent).ok){e.next=12;break}return e.next=11,m(p,"Error when uploading to Gaia hub.",a);case 11:throw e.sent;case 12:return e.next=14,p.text();case 14:return e.abrupt("return",JSON.parse(e.sent));case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function p(e,t){return h.apply(this,arguments)}function h(){return(h=i(u.mark((function e(t,r){var a;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.Logger.debug("deleteFromGaiaHub: deleting "+t+" from "+r.server),e.next=3,n.fetchPrivate(r.server+"/delete/"+r.address+"/"+t,{method:"DELETE",headers:{Authorization:"bearer "+r.token}});case 3:if((a=e.sent).ok){e.next=8;break}return e.next=7,m(a,"Error deleting file from Gaia hub.",r);case 7:throw e.sent;case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function l(e,t){return Promise.resolve(""+t.url_prefix+t.address+"/"+e)}function d(n,a,o,i){var s=n.challenge_text,u=n.latest_auth_version&&parseInt(n.latest_auth_version.slice(1),10)>=1,c=r.getPublicKeyFromPrivate(a);if(!u)return function(t,n){var a;try{a=JSON.parse(t)}catch(e){throw new Error("Failed in parsing legacy challenge text from the gaia hub.")}if("gaiahub"===a[0]&&"blockstack_storage_please_sign"===a[3]){var o=r.hexStringToECPair(n+(64===n.length?"01":"")),i=r.hashSha256Sync(Buffer.from(t)),s=o.sign(i),u=e.script.signature.encode(s,e.Transaction.SIGHASH_NONE).toString("hex").slice(0,-2),c=r.getPublicKeyFromPrivate(n);return Buffer.from(JSON.stringify({publickey:c,signature:u})).toString("base64")}throw new Error("Failed to connect to legacy gaia hub. If you operate this hub, please update.")}(s,a);var f={gaiaChallenge:s,hubUrl:o,iss:c,salt:r.randomBytes(16).toString("hex"),associationToken:i};return"v1:"+new t.TokenSigner("ES256K",a).sign(f)}function g(e,t,r){return y.apply(this,arguments)}function y(){return(y=i(u.mark((function e(t,a,o){var i,s,c,f,p;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.Logger.debug("connectToGaiaHub: "+t+"/hub_info"),e.next=3,n.fetchPrivate(t+"/hub_info");case 3:return i=e.sent,e.next=6,i.json();case 6:return c=(s=e.sent).read_url_prefix,f=d(s,a,t,o),p=r.ecPairToAddress(r.hexStringToECPair(a+(64===a.length?"01":""))),e.abrupt("return",{url_prefix:c,max_file_upload_size_megabytes:s.max_file_upload_size_megabytes,address:p,token:f,server:t});case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function b(e,t){return v.apply(this,arguments)}function v(){return(v=i(u.mark((function t(a,o){var i,s,c,f,p;return u.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=e.ECPair.fromPrivateKey(Buffer.from(o,"hex")),t.next=3,n.fetchPrivate(a+"/hub_info");case 3:return s=t.sent,t.next=6,s.text();case 6:return c=JSON.parse(t.sent),f=c.read_url_prefix,p=r.ecPairToAddress(i),t.abrupt("return",""+f+p+"/");case 12:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function x(e){return w.apply(this,arguments)}function w(){return(w=i(u.mark((function e(t){var r,a;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r="",e.prev=1,e.next=4,t.text();case 4:r=e.sent;try{a=JSON.parse(r)}catch(e){}e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),n.Logger.debug("Error getting bad http response text: "+e.t0);case 11:return e.abrupt("return",{status:t.status,statusText:t.statusText,body:a||r});case 15:case"end":return e.stop()}}),e,null,[[1,8]])})))).apply(this,arguments)}function m(e,t,r){return k.apply(this,arguments)}function k(){return(k=i(u.mark((function e(t,r,a){var o,i;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.ok){e.next=2;break}throw new Error("Cannot get a BlockstackError from a valid response.");case 2:return e.next=4,x(t);case 4:if(401!==(o=e.sent).status){e.next=9;break}return e.abrupt("return",new n.ValidationError(r,o));case 9:if(402!==o.status){e.next=13;break}return e.abrupt("return",new n.NotEnoughProofError(r,o));case 13:if(403!==o.status){e.next=17;break}return e.abrupt("return",new n.BadPathError(r,o));case 17:if(404!==o.status){e.next=21;break}throw new n.DoesNotExist(r,o);case 21:if(409!==o.status){e.next=25;break}return e.abrupt("return",new n.ConflictError(r,o));case 25:if(412!==o.status){e.next=29;break}return e.abrupt("return",new n.PreconditionFailedError(r,o));case 29:if(413!==o.status){e.next=34;break}return i=a&&a.max_file_upload_size_megabytes?n.megabytesToBytes(a.max_file_upload_size_megabytes):0,e.abrupt("return",new n.PayloadTooLargeError(r,o,i));case 34:return e.abrupt("return",new Error(r));case 35:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var S=function(){function e(t,r){this.wasString="string"==typeof t,this.content=e.normalizeContentDataType(t,r),this.contentType=r||this.detectContentType(),this.contentByteLength=this.detectContentLength()}e.normalizeContentDataType=function(e,t){try{if("string"==typeof e){var r=(t||"").toLowerCase().replace("-","");if(r.includes("charset")&&!r.includes("charset=utf8")&&!r.includes("charset=ascii"))throw new Error("Unable to determine byte length with charset: "+t);if("undefined"!=typeof TextEncoder){var n=(new TextEncoder).encode(e);return Buffer.from(n.buffer)}return Buffer.from(e)}if(Buffer.isBuffer(e))return e;if(ArrayBuffer.isView(e))return Buffer.from(e.buffer,e.byteOffset,e.byteLength);if("undefined"!=typeof Blob&&e instanceof Blob)return e;if("undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer)return Buffer.from(e);if(Array.isArray(e)){if(e.length>0&&(!Number.isInteger(e[0])||e[0]<0||e[0]>255))throw new Error('Unexpected array values provided as file data: value "'+e[0]+'" at index 0 is not an octet number. '+this.supportedTypesMsg);return Buffer.from(e)}var a=Object.prototype.toString.call(e);throw new Error("Unexpected type provided as file data: "+a+". "+this.supportedTypesMsg)}catch(e){throw console.error(e),new Error("Error processing data: "+e)}};var t=e.prototype;return t.detectContentType=function(){return this.wasString?"text/plain; charset=utf-8":"undefined"!=typeof Blob&&this.content instanceof Blob&&this.content.type?this.content.type:"application/octet-stream"},t.detectContentLength=function(){if(ArrayBuffer.isView(this.content)||Buffer.isBuffer(this.content))return this.content.byteLength;if("undefined"!=typeof Blob&&this.content instanceof Blob)return this.content.size;var e=Object.prototype.toString.call(this.content),t=new Error('Unexpected type "'+e+'" while detecting content length');throw console.error(t),t},t.loadContent=function(){var e=i(u.mark((function e(){var t,r,n,a,o=this;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!Buffer.isBuffer(this.content)){e.next=5;break}return e.abrupt("return",this.content);case 5:if(!ArrayBuffer.isView(this.content)){e.next=9;break}return e.abrupt("return",Buffer.from(this.content.buffer,this.content.byteOffset,this.content.byteLength));case 9:if(!("undefined"!=typeof Blob&&this.content instanceof Blob)){e.next=18;break}return t=new FileReader,r=new Promise((function(e,r){t.onerror=function(e){r(e)},t.onload=function(){e(Buffer.from(t.result))},t.readAsArrayBuffer(o.content)})),e.next=14,r;case 14:return e.abrupt("return",e.sent);case 18:throw n=Object.prototype.toString.call(this.content),new Error("Unexpected type "+n);case 20:e.next=28;break;case 22:throw e.prev=22,e.t0=e.catch(0),console.error(e.t0),a=new Error("Error loading content: "+e.t0),console.error(a),a;case 28:case"end":return e.stop()}}),e,this,[[0,22]])})));return function(){return e.apply(this,arguments)}}(),t.load=function(){return void 0===this.loadedData&&(this.loadedData=this.loadContent()),this.loadedData},e}();S.supportedTypesMsg="Supported types are: `string` (to be UTF8 encoded), `Buffer`, `Blob`, `File`, `ArrayBuffer`, `UInt8Array` or any other typed array buffer. ";var E=function(){function e(e){this.userSession=e.userSession}var t=e.prototype;return t.getFile=function(){var e=i(u.mark((function e(t,r){var a,o,i,s;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a={decrypt:!0,verify:!1,app:n.getGlobalObject("location",{returnEmptyObject:!0}).origin},!(o=Object.assign({},a,r)).verify||o.decrypt){e.next=4;break}return e.abrupt("return",this.getFileSignedUnencrypted(t,o));case 4:return e.next=6,this.getFileContents(t,o.app,o.username,o.zoneFileLookupURL,!!o.decrypt);case 6:if(null!==(i=e.sent)){e.next=11;break}return e.abrupt("return",i);case 11:if(!o.decrypt||o.verify){e.next=22;break}if("string"==typeof i){e.next=14;break}throw new Error("Expected to get back a string for the cipherText");case 14:if("string"!=typeof o.decrypt){e.next=19;break}return e.abrupt("return",this.userSession.decryptContent(i,{privateKey:o.decrypt}));case 19:return e.abrupt("return",this.userSession.decryptContent(i));case 20:e.next=34;break;case 22:if(!o.decrypt||!o.verify){e.next=29;break}if("string"==typeof i){e.next=25;break}throw new Error("Expected to get back a string for the cipherText");case 25:return"string"==typeof o.decrypt&&(s=o.decrypt),e.abrupt("return",this.handleSignedEncryptedContents(t,i,o.app,s,o.username,o.zoneFileLookupURL));case 29:if(o.verify||o.decrypt){e.next=33;break}return e.abrupt("return",i);case 33:throw new Error("Should be unreachable.");case 34:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),t.getUserAppFileUrl=function(){var e=i(u.mark((function e(t,r,n,o){var i,s,c;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.lookupProfile({username:r,zoneFileLookupURL:o});case 2:return(i=e.sent).hasOwnProperty("apps")&&i.apps.hasOwnProperty(n)&&(c=i.apps[n].replace(/\/?(\?|#|$)/,"/$1"),s=""+c+t),e.abrupt("return",s);case 5:case"end":return e.stop()}}),e)})));return function(t,r,n,a){return e.apply(this,arguments)}}(),t.getGaiaAddress=function(){var e=i(u.mark((function e(t,r,n){var a,o,i,s;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=L(this.userSession,{app:t,username:r,zoneFileLookupURL:n}),!r){e.next=7;break}return e.next=4,this.getUserAppFileUrl("/",a.username,a.app,a.zoneFileLookupURL);case 4:o=e.sent,e.next=13;break;case 7:return e.next=9,this.getOrSetLocalGaiaHubConnection();case 9:return i=e.sent,e.next=12,l("/",i);case 12:o=e.sent;case 13:if(s=o.match(/([13][a-km-zA-HJ-NP-Z0-9]{26,35})/)){e.next=16;break}throw new Error("Failed to parse gaia address");case 16:return e.abrupt("return",s[s.length-1]);case 17:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),t.getFileUrl=function(){var e=i(u.mark((function e(t,r){var n,a,o;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=L(this.userSession,r)).username){e.next=7;break}return e.next=4,this.getUserAppFileUrl(t,n.username,n.app,n.zoneFileLookupURL);case 4:a=e.sent,e.next=13;break;case 7:return e.next=9,this.getOrSetLocalGaiaHubConnection();case 9:return o=e.sent,e.next=12,l(t,o);case 12:a=e.sent;case 13:if(a){e.next=17;break}throw new Error("Missing readURL");case 17:return e.abrupt("return",a);case 18:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),t.getFileContents=function(){var e=i(u.mark((function e(t,r,a,o,i){var s,c,f,p,h,l;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s={app:r,username:a,zoneFileLookupURL:o},e.next=3,this.getFileUrl(t,s);case 3:return c=e.sent,e.next=6,n.fetchPrivate(c);case 6:if((f=e.sent).ok){e.next=11;break}return e.next=10,m(f,"getFile "+t+" failed.",null);case 10:throw e.sent;case 11:if("string"==typeof(p=f.headers.get("Content-Type"))&&(p=p.toLowerCase()),(h=f.headers.get("ETag"))&&((l=this.userSession.store.getSessionData()).etags[t]=h,this.userSession.store.setSessionData(l)),!(i||null===p||p.startsWith("text")||p.startsWith("application/json"))){e.next=19;break}return e.abrupt("return",f.text());case 19:return e.abrupt("return",f.arrayBuffer());case 20:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a,o){return e.apply(this,arguments)}}(),t.getFileSignedUnencrypted=function(){var e=i(u.mark((function e(t,a){var o,i,s,c,f,p,h,l,d;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=t+".sig",e.prev=1,e.next=4,Promise.all([this.getFileContents(t,a.app,a.username,a.zoneFileLookupURL,!1),this.getFileContents(o,a.app,a.username,a.zoneFileLookupURL,!0),this.getGaiaAddress(a.app,a.username,a.zoneFileLookupURL)]);case 4:if(c=(i=e.sent)[1],f=i[2],s=i[0]){e.next=10;break}return e.abrupt("return",s);case 10:if(f){e.next=12;break}throw new n.SignatureVerificationError("Failed to get gaia address for verification of: "+t);case 12:if(c&&"string"==typeof c){e.next=14;break}throw new n.SignatureVerificationError("Failed to obtain signature for file: "+t+" -- looked in "+t+".sig");case 14:e.prev=14,l=JSON.parse(c),p=l.signature,h=l.publicKey,e.next=27;break;case 20:if(e.prev=20,e.t0=e.catch(14),!(e.t0 instanceof SyntaxError)){e.next=26;break}throw new Error("Failed to parse signature content JSON (path: "+t+".sig) The content may be corrupted.");case 26:throw e.t0;case 27:if(d=r.publicKeyToAddress(h),f===d){e.next=32;break}throw new n.SignatureVerificationError("Signer pubkey address ("+d+") doesn't match gaia address ("+f+")");case 32:if(r.verifyECDSA(s,h,p)){e.next=36;break}throw new n.SignatureVerificationError("Contents do not match ECDSA signature: path: "+t+", signature: "+t+".sig");case 36:return e.abrupt("return",s);case 37:e.next=46;break;case 39:if(e.prev=39,e.t1=e.catch(1),!(e.t1 instanceof n.DoesNotExist&&e.t1.message.indexOf(o)>=0)){e.next=45;break}throw new n.SignatureVerificationError("Failed to obtain signature for file: "+t+" -- looked in "+t+".sig");case 45:throw e.t1;case 46:case"end":return e.stop()}}),e,this,[[1,39],[14,20]])})));return function(t,r){return e.apply(this,arguments)}}(),t.handleSignedEncryptedContents=function(){var e=i(u.mark((function e(t,a,o,i,s,c){var f,p,h,l,d,g,y,b;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(f=i||this.userSession.loadUserData().appPrivateKey,p=r.getPublicKeyFromPrivate(f),!s){e.next=8;break}return e.next=5,this.getGaiaAddress(o,s,c);case 5:h=e.sent,e.next=9;break;case 8:h=r.publicKeyToAddress(p);case 9:if(h){e.next=11;break}throw new n.SignatureVerificationError("Failed to get gaia address for verification of: "+t);case 11:e.prev=11,l=JSON.parse(a),e.next=22;break;case 15:if(e.prev=15,e.t0=e.catch(11),!(e.t0 instanceof SyntaxError)){e.next=21;break}throw new Error("Failed to parse encrypted, signed content JSON. The content may not be encrypted. If using getFile, try passing { verify: false, decrypt: false }.");case 21:throw e.t0;case 22:if(d=l.signature,y=l.cipherText,b=r.publicKeyToAddress(g=l.publicKey),g&&y&&d){e.next=30;break}throw new n.SignatureVerificationError("Failed to get signature verification data from file: "+t);case 30:if(b===h){e.next=34;break}throw new n.SignatureVerificationError("Signer pubkey address ("+b+") doesn't match gaia address ("+h+")");case 34:if(r.verifyECDSA(y,g,d)){e.next=38;break}throw new n.SignatureVerificationError("Contents do not match ECDSA signature in file: "+t);case 38:if("string"!=typeof i){e.next=43;break}return e.abrupt("return",this.userSession.decryptContent(y,{privateKey:i}));case 43:return e.abrupt("return",this.userSession.decryptContent(y));case 44:case"end":return e.stop()}}),e,this,[[11,15]])})));return function(t,r,n,a,o,i){return e.apply(this,arguments)}}(),t.putFile=function(){var e=i(u.mark((function e(t,a,o){var s,f,p,h,l,d,g,y,b,v,x,w,m,k,E,L,T,_,F,P,O,B,U,A=this;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=Object.assign({},{encrypt:!0,sign:!1,cipherTextEncoding:"hex",dangerouslyIgnoreEtag:!1},o),e.next=4,this.getOrSetLocalGaiaHubConnection();case 4:if(p=n.megabytesToBytes((f=e.sent).max_file_upload_size_megabytes),h=p>0,l=new S(a,s.contentType),d=l.contentType,!(!s.encrypt&&h&&l.contentByteLength>p)){e.next=14;break}throw g=new n.PayloadTooLargeError("The max file upload size for this hub is "+p+" bytes, the given content is "+l.contentByteLength+" bytes",null,p),console.error(g),g;case 14:if(!s.encrypt||!h){e.next=21;break}if(!((y=r.eciesGetJsonStringLength({contentLength:l.contentByteLength,wasString:l.wasString,sign:!!s.sign,cipherTextEncoding:s.cipherTextEncoding}))>p)){e.next=21;break}throw b=new n.PayloadTooLargeError("The max file upload size for this hub is "+p+" bytes, the given content is "+y+" bytes after encryption",null,p),console.error(b),b;case 21:if(x=!0,w=this.userSession.store.getSessionData(),s.dangerouslyIgnoreEtag||(null==(m=w.etags)?void 0:m[t])&&(x=!1,v=null==(k=w.etags)?void 0:k[t]),s.encrypt||!s.sign){e.next=34;break}return e.next=27,l.load();case 27:L=e.sent,T="string"==typeof s.sign?s.sign:this.userSession.loadUserData().appPrivateKey,_=r.signECDSA(T,L),F=JSON.stringify(_),E=function(){var e=i(u.mark((function e(r){var n;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([c(t,L,r,d,x,v,s.dangerouslyIgnoreEtag),c(t+".sig",F,r,"application/json")]);case 2:return n=e.sent[0],!s.dangerouslyIgnoreEtag&&n.etag&&(w.etags[t]=n.etag,A.userSession.store.setSessionData(w)),e.abrupt("return",n.publicURL);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.next=47;break;case 34:if(s.encrypt||s.sign){e.next=38;break}P=l.content,e.next=46;break;case 38:return O="string"==typeof s.encrypt?s.encrypt:r.getPublicKeyFromPrivate("string"==typeof s.sign?s.sign:this.userSession.loadUserData().appPrivateKey),e.next=41,l.load();case 41:return B=e.sent,e.next=44,this.userSession.encryptContent(B,{publicKey:O,wasString:l.wasString,cipherTextEncoding:s.cipherTextEncoding,sign:s.sign});case 44:P=e.sent,d="application/json";case 46:E=function(){var e=i(u.mark((function e(r){var n;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c(t,P,r,d,x,v,s.dangerouslyIgnoreEtag);case 2:return(n=e.sent).etag&&(w.etags[t]=n.etag,A.userSession.store.setSessionData(w)),e.abrupt("return",n.publicURL);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();case 47:return e.prev=47,e.next=50,E(f);case 50:return e.abrupt("return",e.sent);case 53:if(e.prev=53,e.t0=e.catch(47),!C(e.t0)){e.next=66;break}return console.error(e.t0),console.error("Possible recoverable error during Gaia upload, retrying..."),e.next=60,this.setLocalGaiaHubConnection();case 60:return U=e.sent,e.next=63,E(U);case 63:return e.abrupt("return",e.sent);case 66:throw e.t0;case 67:case"end":return e.stop()}}),e,this,[[47,53]])})));return function(t,r,n){return e.apply(this,arguments)}}(),t.deleteFile=function(){var e=i(u.mark((function e(t,r){var n,a,o,i,s;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getOrSetLocalGaiaHubConnection();case 2:if(n=e.sent,a=Object.assign({},r),o=this.userSession.store.getSessionData(),!a.wasSigned){e.next=28;break}return e.prev=6,e.next=9,p(t,n);case 9:return e.next=11,p(t+".sig",n);case 11:delete o.etags[t],this.userSession.store.setSessionData(o),e.next=26;break;case 15:return e.prev=15,e.t0=e.catch(6),e.next=19,this.setLocalGaiaHubConnection();case 19:return i=e.sent,e.next=22,p(t,i);case 22:return e.next=24,p(t+".sig",n);case 24:delete o.etags[t],this.userSession.store.setSessionData(o);case 26:e.next=44;break;case 28:return e.prev=28,e.next=31,p(t,n);case 31:delete o.etags[t],this.userSession.store.setSessionData(o),e.next=44;break;case 35:return e.prev=35,e.t1=e.catch(28),e.next=39,this.setLocalGaiaHubConnection();case 39:return s=e.sent,e.next=42,p(t,s);case 42:delete o.etags[t],this.userSession.store.setSessionData(o);case 44:case"end":return e.stop()}}),e,this,[[6,15],[28,35]])})));return function(t,r){return e.apply(this,arguments)}}(),t.getAppBucketUrl=function(e,t){return b(e,t)},t.listFilesLoop=function(){var e=i(u.mark((function e(t,r,a,o,i){var s,c,f,p,h,l,d,g;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(a>65536)){e.next=2;break}throw new Error("Too many entries to list");case 2:if(e.t0=t,e.t0){e.next=7;break}return e.next=6,this.getOrSetLocalGaiaHubConnection();case 6:e.t0=e.sent;case 7:return t=e.t0,e.prev=8,c=JSON.stringify({page:r}),f={method:"POST",headers:{"Content-Type":"application/json","Content-Length":""+c.length,Authorization:"bearer "+t.token},body:c},e.next=13,n.fetchPrivate(t.server+"/list-files/"+t.address,f);case 13:if((s=e.sent).ok){e.next=18;break}return e.next=17,m(s,"ListFiles failed.",t);case 17:throw e.sent;case 18:e.next=28;break;case 20:if(e.prev=20,e.t1=e.catch(8),0!==a){e.next=27;break}return e.next=25,this.setLocalGaiaHubConnection();case 25:return e.abrupt("return",this.listFilesLoop(e.sent,r,a+1,0,i));case 27:throw e.t1;case 28:return e.next=30,s.text();case 30:if(p=JSON.parse(e.sent),l=p.page,null!=(h=p.entries)){e.next=36;break}throw new Error("Bad listFiles response: no entries");case 36:d=0,g=0;case 38:if(!(g<h.length)){e.next=47;break}if(null===h[g]){e.next=44;break}if(d++,i(h[g])){e.next=44;break}return e.abrupt("return",o+g);case 44:g++,e.next=38;break;case 47:if(!(l&&h.length>0)){e.next=51;break}return e.abrupt("return",this.listFilesLoop(t,l,a+1,o+d,i));case 51:return e.abrupt("return",o+d);case 52:case"end":return e.stop()}}),e,this,[[8,20]])})));return function(t,r,n,a,o){return e.apply(this,arguments)}}(),t.listFiles=function(e){return this.listFilesLoop(null,null,0,0,e)},t.getOrSetLocalGaiaHubConnection=function(){var e=i(u.mark((function e(){var t,r,a;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.userSession.store.getSessionData(),r=t.userData){e.next=4;break}throw new n.InvalidStateError("Missing userData");case 4:if(!(a=r.gaiaHubConfig)){e.next=7;break}return e.abrupt("return",Promise.resolve(a));case 7:return e.abrupt("return",this.setLocalGaiaHubConnection());case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.setLocalGaiaHubConnection=function(){var e=i(u.mark((function e(){var t,r,a;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.userSession.loadUserData()){e.next=3;break}throw new n.InvalidStateError("Missing userData");case 3:return t.hubUrl||(t.hubUrl=n.BLOCKSTACK_DEFAULT_GAIA_HUB_URL),e.next=6,g(t.hubUrl,t.appPrivateKey,t.gaiaAssociationToken);case 6:return t.gaiaHubConfig=r=e.sent,(a=this.userSession.store.getSessionData()).userData.gaiaHubConfig=r,this.userSession.store.setSessionData(a),e.abrupt("return",r);case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),e}();function L(e,t){var r=Object.assign({},t);if(r.username){if(!r.app){if(!e.appConfig)throw new n.InvalidStateError("Missing AppConfig");r.app=e.appConfig.appDomain}if(!r.zoneFileLookupURL){if(!e.appConfig)throw new n.InvalidStateError("Missing AppConfig");if(!e.store)throw new n.InvalidStateError("Missing store UserSession");var o=e.store.getSessionData().userData.coreNode||e.appConfig.coreNode;o&&(r.zoneFileLookupURL=""+o+a.NAME_LOOKUP_PATH)}}return r}function C(e){if(!e||!e.hubError||!e.hubError.statusCode)return!1;var t=e.hubError.statusCode;return 401===t||409===t||t>=500&&t<=599}exports.BLOCKSTACK_GAIA_HUB_LABEL="blockstack-gaia-hub-config",exports.Storage=E,exports.connectToGaiaHub=g,exports.deleteFromGaiaHub=p,exports.getBucketUrl=b,exports.getFullReadUrl=l,exports.uploadToGaiaHub=c;
//# sourceMappingURL=storage.cjs.production.min.js.map
